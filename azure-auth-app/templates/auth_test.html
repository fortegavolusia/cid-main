<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Auth Service Test</title>
    <style>
        /* Ant Design Inspired Styles */
        :root {
            /* Colors */
            --primary-color: #1890ff;
            --success-color: #52c41a;
            --warning-color: #faad14;
            --error-color: #ff4d4f;
            --info-color: #1890ff;
            --header-bg: #001529;
            --sidebar-bg: #001529;
            --text-primary: rgba(0, 0, 0, 0.85);
            --text-secondary: rgba(0, 0, 0, 0.45);
            --border-color: #f0f0f0;
            --bg-color: #f0f2f5;
            --card-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.03), 0 1px 6px -1px rgba(0, 0, 0, 0.02), 0 2px 4px 0 rgba(0, 0, 0, 0.02);
            --border-radius: 6px;
        }
        
        * {
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            font-size: 14px;
            line-height: 1.5715;
            margin: 0;
            padding: 0;
            background-color: var(--bg-color);
            color: var(--text-primary);
            display: flex;
        }
        
        /* Sidebar */
        .sidebar {
            position: fixed;
            left: 0;
            top: 0;
            width: 280px;
            height: 100vh;
            background-color: var(--sidebar-bg);
            color: rgba(255, 255, 255, 0.85);
            padding: 24px;
            box-sizing: border-box;
            box-shadow: 2px 0 8px 0 rgba(29, 35, 41, 0.05);
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            transition: all 0.3s ease;
            z-index: 1000;
        }
        
        .sidebar.collapsed {
            transform: translateX(-280px);
        }
        
        .sidebar-toggle {
            position: fixed;
            left: 280px;
            top: 50%;
            transform: translateY(-50%);
            width: 30px;
            height: 60px;
            background-color: var(--sidebar-bg);
            color: rgba(255, 255, 255, 0.85);
            border: 1px solid rgba(255, 255, 255, 0.12);
            border-left: none;
            border-radius: 0 var(--border-radius) var(--border-radius) 0;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 2px 0 8px 0 rgba(29, 35, 41, 0.05);
            transition: all 0.3s ease;
            z-index: 999;
            font-size: 16px;
        }
        
        .sidebar-toggle:hover {
            background-color: #1890ff;
            color: white;
        }
        
        .sidebar.collapsed ~ .sidebar-toggle {
            left: 0;
        }
        
        .sidebar-toggle-icon {
            transition: transform 0.3s ease;
        }
        
        .sidebar.collapsed ~ .sidebar-toggle .sidebar-toggle-icon {
            transform: rotate(180deg);
        }
        
        .sidebar h2 {
            color: rgba(255, 255, 255, 0.85);
            margin-bottom: 24px;
            font-size: 16px;
            font-weight: 500;
            border-bottom: 1px solid rgba(255, 255, 255, 0.12);
            padding-bottom: 16px;
        }
        
        .sidebar-content {
            flex: 1;
        }
        
        .sidebar-footer {
            margin-top: auto;
            padding-top: 24px;
            border-top: 1px solid rgba(255, 255, 255, 0.12);
        }
        
        /* Main Content */
        .main-content {
            margin-left: 280px;
            padding: 24px;
            width: calc(100% - 280px);
            min-height: 100vh;
            transition: all 0.3s ease;
        }
        
        .main-content.expanded {
            margin-left: 30px;
            width: calc(100% - 30px);
        }
        
        /* Card Container */
        .container {
            background-color: white;
            border-radius: var(--border-radius);
            box-shadow: var(--card-shadow);
            padding: 24px;
            margin: 0 0 24px 0;
        }
        
        h1 {
            color: var(--text-primary);
            margin: 0 0 24px 0;
            font-size: 24px;
            font-weight: 500;
        }
        
        h2 {
            color: var(--text-primary);
            margin: 0 0 16px 0;
            font-size: 18px;
            font-weight: 500;
        }
        
        h3 {
            color: var(--text-primary);
            margin: 0 0 12px 0;
            font-size: 16px;
            font-weight: 500;
        }
        
        /* Buttons */
        .button {
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: var(--border-radius);
            cursor: pointer;
            text-decoration: none;
            display: inline-block;
            margin: 4px 0;
            transition: all 0.3s ease;
            font-size: 14px;
            line-height: 1.5715;
            font-weight: 400;
            box-shadow: 0 2px 0 rgba(0, 0, 0, 0.015);
            width: 100%;
            text-align: center;
        }
        
        .button:hover {
            background-color: #40a9ff;
            box-shadow: 0 2px 0 rgba(0, 0, 0, 0.045);
        }
        
        .button:active {
            background-color: #096dd9;
        }
        
        .button.danger {
            background-color: var(--error-color);
        }
        
        .button.danger:hover {
            background-color: #ff7875;
        }
        
        .sidebar .button {
            background-color: transparent;
            border: 1px solid rgba(255, 255, 255, 0.25);
            color: rgba(255, 255, 255, 0.85);
        }
        
        .sidebar .button:hover {
            background-color: var(--primary-color);
            border-color: var(--primary-color);
            color: white;
        }
        .sidebar .action-description {
            font-size: 12px;
            color: rgba(255, 255, 255, 0.45);
            margin-bottom: 16px;
            line-height: 1.5715;
        }
        
        .dropdown {
            margin-bottom: 24px;
        }
        
        .dropdown-header {
            background-color: rgba(255, 255, 255, 0.04);
            padding: 12px 16px;
            border-radius: var(--border-radius);
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            user-select: none;
            transition: all 0.3s ease;
            border: 1px solid transparent;
        }
        
        .dropdown-header:hover {
            background-color: rgba(255, 255, 255, 0.08);
            border-color: var(--primary-color);
        }
        
        .dropdown-arrow {
            transition: transform 0.3s ease;
            font-size: 12px;
            color: rgba(255, 255, 255, 0.45);
        }
        
        .dropdown-arrow.open {
            transform: rotate(180deg);
        }
        
        .dropdown-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
            margin-top: 8px;
        }
        
        .dropdown-content.open {
            max-height: 500px;
        }
        .logout-button {
            background-color: transparent;
            border: 1px solid var(--error-color);
            color: var(--error-color);
            width: 100%;
            text-align: center;
            padding: 8px 16px;
            border-radius: var(--border-radius);
            text-decoration: none;
            display: block;
            transition: all 0.3s ease;
            font-size: 14px;
            line-height: 1.5715;
        }
        
        .logout-button:hover {
            background-color: var(--error-color);
            color: white;
            box-shadow: 0 2px 0 rgba(0, 0, 0, 0.045);
        }
        
        /* Info Sections */
        .info-section {
            background-color: white;
            border-radius: var(--border-radius);
            padding: 0;
            margin: 24px 0;
            border: 1px solid var(--border-color);
            box-shadow: var(--card-shadow);
        }
        
        .section-header {
            padding: 16px 24px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            user-select: none;
            transition: all 0.3s ease;
            border-bottom: 1px solid var(--border-color);
        }
        
        .section-header:hover {
            background-color: #fafafa;
        }
        
        .section-content {
            padding: 24px;
            display: none;
        }
        
        .section-content.active {
            display: block;
        }
        
        .collapse-icon {
            font-size: 14px;
            transition: transform 0.3s ease;
            color: var(--text-secondary);
        }
        
        .collapse-icon.rotated {
            transform: rotate(180deg);
        }
        
        /* Token Display */
        .token-display {
            background-color: #f6f8fa;
            padding: 16px;
            border-radius: var(--border-radius);
            font-family: 'SF Mono', Monaco, 'Cascadia Mono', 'Roboto Mono', Consolas, 'Courier New', monospace;
            font-size: 13px;
            word-break: break-all;
            margin: 16px 0;
            border: 1px solid var(--border-color);
        }
        
        /* Status Badges */
        .status {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 4px;
            font-weight: 400;
            font-size: 12px;
            margin: 8px 0;
        }
        
        .status.authenticated {
            background-color: #f6ffed;
            color: var(--success-color);
            border: 1px solid #b7eb8f;
        }
        
        .status.not-authenticated {
            background-color: #fff2e8;
            color: var(--warning-color);
            border: 1px solid #ffbb96;
        }
        /* Code blocks */
        pre {
            background-color: #f6f8fa;
            padding: 16px;
            border-radius: var(--border-radius);
            overflow-x: auto;
            font-family: 'SF Mono', Monaco, 'Cascadia Mono', 'Roboto Mono', Consolas, 'Courier New', monospace;
            font-size: 13px;
            line-height: 1.45;
            border: 1px solid var(--border-color);
            margin: 16px 0;
        }
        
        /* Group List */
        .group-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        
        .group-item {
            background-color: #fafafa;
            padding: 12px 16px;
            margin: 8px 0;
            border-radius: var(--border-radius);
            display: flex;
            justify-content: space-between;
            align-items: center;
            border: 1px solid var(--border-color);
            transition: all 0.3s ease;
        }
        
        .group-item:hover {
            box-shadow: var(--card-shadow);
            border-color: var(--primary-color);
        }
        
        .group-name {
            font-weight: 500;
            color: var(--text-primary);
            font-size: 14px;
        }
        
        .group-id {
            font-family: 'SF Mono', Monaco, 'Cascadia Mono', 'Roboto Mono', Consolas, 'Courier New', monospace;
            font-size: 12px;
            color: var(--text-secondary);
        }
        
        /* Flow Diagram */
        .flow-diagram {
            background-color: #fafafa;
            padding: 24px;
            border-radius: var(--border-radius);
            margin: 24px 0;
            border: 1px solid var(--border-color);
        }
        
        .flow-step {
            padding: 16px;
            margin: 12px 0;
            background-color: white;
            border-left: 3px solid var(--primary-color);
            border-radius: var(--border-radius);
            box-shadow: var(--card-shadow);
            transition: all 0.3s ease;
        }
        
        .flow-step:hover {
            transform: translateX(4px);
        }
        
        .flow-step-number {
            display: inline-block;
            width: 32px;
            height: 32px;
            background-color: var(--primary-color);
            color: white;
            text-align: center;
            line-height: 32px;
            border-radius: 50%;
            margin-right: 12px;
            font-weight: 500;
            font-size: 14px;
        }
        
        /* Explanation boxes */
        .explanation {
            background-color: #e6f7ff;
            padding: 16px;
            border-radius: var(--border-radius);
            margin: 16px 0;
            border-left: 4px solid var(--info-color);
            color: var(--text-primary);
        }
        
        .explanation h3 {
            margin-top: 0;
            color: var(--primary-color);
        }
        
        .explanation p {
            margin-bottom: 8px;
            line-height: 1.5715;
        }
        
        /* Tables */
        table {
            width: 100%;
            border-collapse: collapse;
            background-color: white;
            box-shadow: var(--card-shadow);
            border-radius: var(--border-radius);
            overflow: hidden;
        }
        
        th {
            padding: 12px 16px;
            text-align: left;
            font-weight: 500;
            color: var(--text-primary);
            background-color: #fafafa;
            border-bottom: 1px solid var(--border-color);
        }
        
        td {
            padding: 12px 16px;
            border-bottom: 1px solid var(--border-color);
            color: var(--text-primary);
        }
        
        tbody tr:hover {
            background-color: #f5f5f5;
        }
        
        /* Modal Styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.45);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        
        .modal-content {
            background-color: white;
            padding: 24px;
            border-radius: var(--border-radius);
            max-width: 900px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            position: relative;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }
        
        .modal-close {
            position: absolute;
            top: 16px;
            right: 16px;
            background: none;
            border: none;
            font-size: 20px;
            cursor: pointer;
            color: var(--text-secondary);
            transition: color 0.3s ease;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 4px;
        }
        
        .modal-close:hover {
            color: var(--text-primary);
            background-color: #f0f0f0;
        }
        
        /* Action buttons in tables */
        .action-button {
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 6px 16px;
            border-radius: var(--border-radius);
            cursor: pointer;
            font-size: 14px;
            margin-right: 8px;
            transition: all 0.3s ease;
            height: 32px;
            line-height: 1.5715;
        }
        
        .action-button:hover {
            background-color: #40a9ff;
        }
        
        .action-button.success {
            background-color: var(--success-color);
        }
        
        .action-button.success:hover {
            background-color: #73d13d;
        }
        
        .action-button.danger {
            background-color: var(--error-color);
        }
        
        .action-button.danger:hover {
            background-color: #ff7875;
        }
        
        .action-button:disabled {
            background-color: #f5f5f5;
            color: rgba(0, 0, 0, 0.25);
            cursor: not-allowed;
        }
        
        /* Loading states */
        .spinner {
            display: inline-block;
            width: 14px;
            height: 14px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-top-color: white;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            margin-right: 8px;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* Statistics cards */
        .stat-card {
            background-color: white;
            padding: 16px;
            border-radius: var(--border-radius);
            text-align: center;
            border: 1px solid var(--border-color);
            transition: all 0.3s ease;
        }
        
        .stat-card:hover {
            box-shadow: var(--card-shadow);
            transform: translateY(-2px);
        }
        
        .stat-card h3 {
            margin: 0 0 8px 0;
            font-size: 24px;
            font-weight: 500;
        }
        
        .stat-card p {
            margin: 0;
            color: var(--text-secondary);
            font-size: 14px;
        }
        
        /* Responsive adjustments */
        @media (max-width: 768px) {
            .sidebar {
                width: 240px;
            }
            
            .main-content {
                margin-left: 240px;
                width: calc(100% - 240px);
            }
            
            .container {
                padding: 16px;
            }
        }
    </style>
</head>
<body>
    <!-- Fixed Sidebar -->
    <div class="sidebar" id="sidebar">
        <div class="sidebar-content">
            <h2>Auth Service</h2>
            
            {% if not session_data %}
                <a href="/auth/login" class="button">Login with Azure AD</a>
                <p class="action-description">Start the authentication flow with Azure Active Directory</p>
            {% else %}
                <!-- My Token Information Link -->
                <button onclick="window.location.href = '/'" class="button" style="background-color: var(--info-color); width: 100%;">
                    Home / My Token Information
                </button>
                <p class="action-description">Return to home screen with token details and actions</p>
                
                <!-- Administration Dropdown -->
                <button onclick="viewAdministration()" class="button" style="background-color: #722ed1; margin-top: 20px;">
                    Administration
                </button>
                <p class="action-description">View and manage all tokens (internal and Azure)</p>
            {% endif %}
            
            {% if not session_data %}
                <button onclick="getPublicKey()" class="button">View Public Key</button>
                <p class="action-description">Get the public key used to validate internal tokens</p>
            {% endif %}
            
            <hr style="border-color: rgba(255, 255, 255, 0.12); margin: 30px 0;">
            
            <h2>Session Status</h2>
            {% if session_data %}
                <p style="color: var(--success-color);">âœ“ Authenticated</p>
                {% if session_data.user %}
                <p style="font-size: 14px;">User: {{ session_data.user.name }}</p>
                <p style="font-size: 12px; color: rgba(255, 255, 255, 0.65);">{{ session_data.user.email }}</p>
                {% endif %}
            {% else %}
                <p style="color: var(--error-color);">âœ— Not Authenticated</p>
            {% endif %}
        </div>
        
        <div class="sidebar-footer">
            {% if session_data %}
                <a href="/auth/logout" class="logout-button">Logout</a>
            {% endif %}
        </div>
    </div>
    
    <!-- Sidebar Toggle Button -->
    <button class="sidebar-toggle" id="sidebar-toggle" onclick="toggleSidebar()" title="Toggle Sidebar">
        <span class="sidebar-toggle-icon">â—€</span>
    </button>

    <!-- Main Content Area -->
    <div class="main-content" id="main-content">
        <div class="container">
        <h1>Centralized Auth Service Test</h1>
        
        <div class="explanation">
            <h3>What is this page?</h3>
            <p>This is a test interface for the Centralized Authentication Service. It demonstrates how the service integrates with Azure Active Directory (AD) to authenticate users and issue secure tokens for internal applications.</p>
        </div>
        
        {% if session_data %}
        <!-- Action Buttons Section -->
        <div class="info-section" style="margin-bottom: 20px;">
            <div class="section-header" onclick="toggleSection('actions')">
                <h2 style="margin: 0;">Available Actions</h2>
                <span class="collapse-icon" id="actions-icon">â–¼</span>
            </div>
            <div class="section-content active" id="actions">
                <p class="explanation">These actions allow you to interact with your tokens and test the authentication service.</p>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px; margin-top: 20px;">
                    <div>
                        <button onclick="getSessionTokens()" class="button" style="width: 100%; margin-bottom: 5px;">
                            Get Internal Tokens
                        </button>
                        <p style="font-size: 12px; color: #666; margin: 0;">Retrieve current internal access and refresh tokens</p>
                    </div>
                    
                    <div>
                        <button onclick="validateToken()" class="button" style="width: 100%; margin-bottom: 5px;">
                            Validate Internal Access Token
                        </button>
                        <p style="font-size: 12px; color: #666; margin: 0;">Test validation of your internal access token</p>
                    </div>
                    
                    <div>
                        <button onclick="getPublicKey()" class="button" style="width: 100%; margin-bottom: 5px;">
                            View Internal Public Key
                        </button>
                        <p style="font-size: 12px; color: #666; margin: 0;">Get our public key for internal token validation</p>
                    </div>
                    
                    <div>
                        <button onclick="refreshAccessToken()" class="button" style="width: 100%; margin-bottom: 5px;">
                            Refresh Internal Access Token
                        </button>
                        <p style="font-size: 12px; color: #666; margin: 0;">Use internal refresh token to get new access token</p>
                    </div>
                    
                    <div>
                        <button onclick="revokeRefreshToken()" class="button danger" style="width: 100%; margin-bottom: 5px;">
                            Revoke Internal Refresh Token
                        </button>
                        <p style="font-size: 12px; color: #666; margin: 0;">Revoke the current internal refresh token</p>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}
        
        <div class="info-section">
            <div class="section-header" onclick="toggleSection('session')">
                <h2 style="margin: 0;">Current Session</h2>
                <span class="collapse-icon" id="session-icon">â–¼</span>
            </div>
            <div class="section-content active" id="session">
                <p class="explanation">This section shows your current authentication status and session information.</p>
                {% if session_data %}
                <span class="status authenticated">Authenticated</span>
                <p><strong>Session ID:</strong> {{ session_id }}</p>
                {% if session_data.user %}
                <p><strong>User:</strong> {{ session_data.user.name }}</p>
                <p><strong>Email:</strong> {{ session_data.user.email }}</p>
                <p><strong>Azure AD Subject ID:</strong> {{ session_data.user.sub }}</p>
                
                {% if session_data.user.groups %}
                <h3>Active Directory Groups</h3>
                <p>These are the AD groups you belong to:</p>
                <ul class="group-list">
                    {% for group in session_data.user.groups %}
                    <li class="group-item">
                        <span class="group-name">{{ group.displayName }}</span>
                        <span class="group-id">ID: {{ group.id }}</span>
                    </li>
                    {% endfor %}
                </ul>
                {% else %}
                <p><em>No AD groups found or groups were not accessible.</em></p>
                {% endif %}
                {% endif %}
            {% else %}
                <span class="status not-authenticated">Not Authenticated</span>
                <p>You are not currently logged in. Click "Login with Azure AD" below to authenticate.</p>
            {% endif %}
            </div>
        </div>

        {% if internal_token %}
        <div class="info-section">
            <div class="section-header" onclick="toggleSection('token')">
                <h2 style="margin: 0;">Internal Access Token (JWT)</h2>
                <span class="collapse-icon" id="token-icon">â–¼</span>
            </div>
            <div class="section-content active" id="token">
                <p>This is the internal JWT access token your applications use for API authentication:</p>
            <div class="token-display">{{ internal_token }}</div>
            
            <h3>Decoded Token Claims:</h3>
            <p>These are the claims contained in your internal JWT token:</p>
            <pre>{{ token_claims | tojson(indent=2) if token_claims else "No token claims available" }}</pre>
            </div>
        </div>
        {% endif %}

        {% if azure_token and internal_token %}
        <div class="info-section">
            <div class="section-header" onclick="toggleSection('token-comparison')">
                <h2 style="margin: 0;">Azure Tokens vs Internal Tokens</h2>
                <span class="collapse-icon" id="token-comparison-icon">â–¼</span>
            </div>
            <div class="section-content" id="token-comparison">
                <div class="explanation">
                    <p>This section shows how Azure AD tokens are transformed into lightweight internal tokens:</p>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 20px;">
                    <div style="background-color: #f0f8ff; padding: 15px; border-radius: 8px; border: 2px solid #4169e1;">
                        <h3 style="color: #4169e1; margin-top: 0;">Azure ID Token</h3>
                        <p><strong>Issued by:</strong> Microsoft Azure AD</p>
                        <p><strong>Size:</strong> ~{{ azure_token|length }} characters</p>
                        <p><strong>Purpose:</strong> Initial authentication only</p>
                        
                        <h4>Key Claims:</h4>
                        <ul style="font-size: 14px;">
                            <li><strong>iss:</strong> {{ azure_claims.iss }}</li>
                            <li><strong>aud:</strong> {{ azure_claims.aud }}</li>
                            <li><strong>sub:</strong> {{ azure_claims.sub }}</li>
                            <li><strong>name:</strong> {{ azure_claims.name }}</li>
                            <li><strong>email:</strong> {{ azure_claims.email or azure_claims.preferred_username }}</li>
                            <li><strong>groups:</strong> {{ azure_claims.groups|length if azure_claims.groups else 0 }} groups</li>
                            <li><strong>iat:</strong> {{ azure_claims.iat }} ({{ azure_claims.iat|int|datetime }})</li>
                            <li><strong>exp:</strong> {{ azure_claims.exp }} ({{ azure_claims.exp|int|datetime }})</li>
                        </ul>
                        
                        <details style="margin-top: 10px;">
                            <summary style="cursor: pointer; color: #4169e1;">View Full Token</summary>
                            <div class="token-display" style="margin-top: 10px; font-size: 10px;">{{ azure_token }}</div>
                        </details>
                    </div>
                    
                    <div style="background-color: #f0fff0; padding: 15px; border-radius: 8px; border: 2px solid #228b22;">
                        <h3 style="color: #228b22; margin-top: 0;">Internal Access Token</h3>
                        <p><strong>Issued by:</strong> Our Auth Service</p>
                        <p><strong>Size:</strong> ~{{ internal_token|length }} characters</p>
                        <p><strong>Purpose:</strong> API authentication</p>
                        
                        <h4>Key Claims:</h4>
                        <ul style="font-size: 14px;">
                            {% if token_claims %}
                            <li><strong>iss:</strong> {{ token_claims.iss }}</li>
                            <li><strong>aud:</strong> {{ token_claims.aud }}</li>
                            <li><strong>sub:</strong> {{ token_claims.sub }}</li>
                            <li><strong>name:</strong> {{ token_claims.name }}</li>
                            <li><strong>email:</strong> {{ token_claims.email }}</li>
                            <li><strong>groups:</strong> {{ token_claims.groups|length if token_claims.groups else 0 }} groups</li>
                            <li><strong>iat:</strong> {{ token_claims.iat }} ({{ token_claims.iat|int|datetime }})</li>
                            <li><strong>exp:</strong> {{ token_claims.exp }} ({{ token_claims.exp|int|datetime }})</li>
                            {% else %}
                            <li>No token claims available</li>
                            {% endif %}
                        </ul>
                        
                        <details style="margin-top: 10px;">
                            <summary style="cursor: pointer; color: #228b22;">View Full Token</summary>
                            <div class="token-display" style="margin-top: 10px; font-size: 10px;">{{ internal_token }}</div>
                        </details>
                    </div>
                </div>
                
                <div class="explanation" style="margin-top: 20px; background-color: #fffacd; padding: 15px; border-radius: 8px;">
                    <h4>ðŸ”— Token Transformation Process:</h4>
                    <ol>
                        <li><strong>Azure Token Reception:</strong> We receive the Azure ID token after successful authentication</li>
                        <li><strong>Validation:</strong> We validate the Azure token using Microsoft's public keys</li>
                        <li><strong>Data Extraction:</strong> We extract essential user information (name, email, subject ID)</li>
                        <li><strong>Group Enrichment:</strong> We fetch group names from Microsoft Graph API</li>
                        <li><strong>Internal Token Creation:</strong> We create a new, smaller token with only necessary claims</li>
                        <li><strong>Signature:</strong> We sign it with our private key (not Microsoft's)</li>
                    </ol>
                    
                    <h4>ðŸ’¡ Benefits of Token Transformation:</h4>
                    <ul>
                        <li><strong>Size Reduction:</strong> ~{{ ((1 - (internal_token|length / azure_token|length)) * 100)|round|int }}% smaller token</li>
                        <li><strong>Control:</strong> We control expiration, claims, and validation</li>
                        <li><strong>Performance:</strong> Faster validation with local keys</li>
                        <li><strong>Flexibility:</strong> Can add custom claims without affecting Azure AD</li>
                        <li><strong>Security:</strong> Azure tokens never leave our auth service</li>
                    </ul>
                </div>
            </div>
        </div>
        {% endif %}

        <div class="info-section">
            <div class="section-header" onclick="toggleSection('flow')">
                <h2 style="margin: 0;">Authentication Flow</h2>
                <span class="collapse-icon" id="flow-icon">â–¼</span>
            </div>
            <div class="section-content" id="flow">
                <p>Here's how the authentication process works:</p>
            
            <div class="flow-step">
                <span class="flow-step-number">1</span>
                <strong>User Initiates Login</strong>
                <p>User clicks "Login with Azure AD" and is redirected to Microsoft's login page.</p>
            </div>
            
            <div class="flow-step">
                <span class="flow-step-number">2</span>
                <strong>Azure AD Authentication</strong>
                <p>User enters their corporate credentials on Microsoft's secure login page. Azure AD validates the credentials.</p>
            </div>
            
            <div class="flow-step">
                <span class="flow-step-number">3</span>
                <strong>Authorization Code Return</strong>
                <p>After successful authentication, Azure AD redirects back to our service with an authorization code.</p>
            </div>
            
            <div class="flow-step">
                <span class="flow-step-number">4</span>
                <strong>Token Exchange</strong>
                <p>Our service exchanges the authorization code for Azure tokens (ID token and access token) by calling Azure AD's token endpoint.</p>
            </div>
            
            <div class="flow-step">
                <span class="flow-step-number">5</span>
                <strong>Fetch User Groups</strong>
                <p>Using the Azure access token, we call Microsoft Graph API to retrieve the user's AD group memberships.</p>
            </div>
            
            <div class="flow-step">
                <span class="flow-step-number">6</span>
                <strong>Issue Internal Token</strong>
                <p>Our service creates a simplified JWT token containing user info and group IDs, signed with our private key.</p>
            </div>
            
            <div class="flow-step">
                <span class="flow-step-number">7</span>
                <strong>Session Established</strong>
                <p>The internal token is stored in the session, and the user is now authenticated for all internal applications.</p>
            </div>
            </div>
        </div>


        <div id="api-response" style="display:none;" class="info-section">
            <div class="section-header" onclick="toggleSection('api-response-content')">
                <h2 style="margin: 0;">API Response</h2>
                <span class="collapse-icon" id="api-response-content-icon">â–¼</span>
            </div>
            <div class="section-content active" id="api-response-content">
                <pre id="response-content"></pre>
            </div>
        </div>
        </div>
    </div>

    <script>
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const mainContent = document.getElementById('main-content');
            const toggle = document.getElementById('sidebar-toggle');
            
            sidebar.classList.toggle('collapsed');
            mainContent.classList.toggle('expanded');
            
            // Save preference
            localStorage.setItem('sidebarCollapsed', sidebar.classList.contains('collapsed'));
        }
        
        // Restore sidebar state on load
        window.addEventListener('DOMContentLoaded', function() {
            const sidebarCollapsed = localStorage.getItem('sidebarCollapsed') === 'true';
            if (sidebarCollapsed) {
                document.getElementById('sidebar').classList.add('collapsed');
                document.getElementById('main-content').classList.add('expanded');
            }
        });
        
        function toggleSection(sectionId) {
            const section = document.getElementById(sectionId);
            const icon = document.getElementById(sectionId + '-icon');
            
            if (section.classList.contains('active')) {
                section.classList.remove('active');
                icon.classList.add('rotated');
            } else {
                section.classList.add('active');
                icon.classList.remove('rotated');
            }
        }
        
        function toggleDropdown(dropdownId) {
            const dropdown = document.getElementById(dropdownId);
            const arrow = document.getElementById(dropdownId + '-arrow');
            
            if (dropdown.classList.contains('open')) {
                dropdown.classList.remove('open');
                arrow.classList.remove('open');
            } else {
                dropdown.classList.add('open');
                arrow.classList.add('open');
            }
        }

        async function getSessionTokens() {
            try {
                const response = await fetch('/auth/token/session', {
                    method: 'POST',
                    credentials: 'include'
                });
                const data = await response.json();
                showResponse('Session Tokens', data);
            } catch (error) {
                showResponse('Error', {error: error.message});
            }
        }

        async function validateToken() {
            try {
                // First get the token
                const tokenResponse = await fetch('/auth/token/session', {
                    method: 'POST',
                    credentials: 'include'
                });
                const tokenData = await tokenResponse.json();
                
                // Then validate it
                const response = await fetch('/auth/validate', {
                    headers: {
                        'Authorization': `Bearer ${tokenData.access_token}`
                    }
                });
                const data = await response.json();
                showResponse('Token Validation Response', data);
            } catch (error) {
                showResponse('Error', {error: error.message});
            }
        }
        
        async function refreshAccessToken() {
            try {
                // First get current tokens
                const sessionResponse = await fetch('/auth/token/session', {
                    method: 'POST',
                    credentials: 'include'
                });
                const sessionData = await sessionResponse.json();
                
                if (!sessionData.refresh_token) {
                    showResponse('Error', {error: 'No refresh token available'});
                    return;
                }
                
                // Use refresh token to get new access token
                const response = await fetch('/auth/token', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        grant_type: 'refresh_token',
                        refresh_token: sessionData.refresh_token
                    })
                });
                
                const data = await response.json();
                showResponse('Refresh Token Response', data);
            } catch (error) {
                showResponse('Error', {error: error.message});
            }
        }
        
        async function revokeRefreshToken() {
            try {
                // First get current tokens
                const sessionResponse = await fetch('/auth/token/session', {
                    method: 'POST',
                    credentials: 'include'
                });
                const sessionData = await sessionResponse.json();
                
                if (!sessionData.refresh_token) {
                    showResponse('Error', {error: 'No refresh token to revoke'});
                    return;
                }
                
                // Revoke the refresh token
                const response = await fetch('/auth/revoke', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        token: sessionData.refresh_token,
                        token_type_hint: 'refresh_token'
                    })
                });
                
                if (response.ok) {
                    showResponse('Token Revocation', {status: 'success', message: 'Refresh token revoked'});
                } else {
                    showResponse('Error', {error: 'Failed to revoke token'});
                }
            } catch (error) {
                showResponse('Error', {error: error.message});
            }
        }

        async function getPublicKey() {
            try {
                const response = await fetch('/auth/public-key');
                const data = await response.json();
                showResponse('Public Key Response', data);
            } catch (error) {
                showResponse('Error', {error: error.message});
            }
        }
        
        async function viewAllTokens() {
            try {
                // First, get the access token from the session
                const tokenResponse = await fetch('/auth/token/session', {
                    method: 'POST',
                    credentials: 'include'
                });
                
                if (!tokenResponse.ok) {
                    showResponse('Error', {error: 'Not authenticated. Please login first.'});
                    return;
                }
                
                const tokenData = await tokenResponse.json();
                const accessToken = tokenData.access_token;
                
                // Store it in localStorage for future use
                localStorage.setItem('access_token', accessToken);
                
                // Now fetch all tokens with the access token
                const response = await fetch('/auth/admin/tokens', {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${accessToken}`
                    },
                    credentials: 'include'
                });
                
                if (!response.ok) {
                    const errorData = await response.json();
                    showResponse('Error', {
                        status: response.status,
                        statusText: response.statusText,
                        detail: errorData.detail || 'Failed to fetch tokens'
                    });
                    return;
                }
                
                const data = await response.json();
                showAllTokensResponse('All Issued Tokens', data);
            } catch (error) {
                showResponse('Error', {error: error.message});
            }
        }

        function showResponse(title, data) {
            const responseDiv = document.getElementById('api-response');
            const contentDiv = document.getElementById('response-content');
            responseDiv.style.display = 'block';
            contentDiv.textContent = JSON.stringify(data, null, 2);
            responseDiv.scrollIntoView({behavior: 'smooth'});
        }
        
        function showAllTokensResponse(title, data) {
            // Remove existing token list container if it exists
            const existingTokenList = document.getElementById('token-list-container');
            if (existingTokenList) {
                existingTokenList.remove();
            }
            
            // Create a new container for the token list
            const mainContent = document.getElementById('main-content');
            const tokenListContainer = document.createElement('div');
            tokenListContainer.id = 'token-list-container';
            tokenListContainer.className = 'container';
            tokenListContainer.style.marginTop = '20px';
            
            // Helper function to format date in UTC
            function formatDateUTC(utcDate) {
                const options = {
                    timeZone: 'UTC',
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit',
                    hour12: true
                };
                return utcDate.toLocaleString('en-US', options) + ' UTC';
            }
            
            // Helper function to format date nicely with EST indicator
            function formatDateEST(utcDate) {
                const options = {
                    timeZone: 'America/New_York',
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit',
                    hour12: true,
                    timeZoneName: 'short'
                };
                return utcDate.toLocaleString('en-US', options);
            }
            
            // Helper function to format time duration
            function formatTimeDuration(milliseconds) {
                const totalSeconds = Math.floor(Math.abs(milliseconds) / 1000);
                const days = Math.floor(totalSeconds / (24 * 3600));
                const hours = Math.floor((totalSeconds % (24 * 3600)) / 3600);
                const minutes = Math.floor((totalSeconds % 3600) / 60);
                const seconds = totalSeconds % 60;
                
                let parts = [];
                if (days > 0) parts.push(`${days}d`);
                if (hours > 0) parts.push(`${hours}h`);
                if (minutes > 0) parts.push(`${minutes}m`);
                if (seconds > 0 && days === 0) parts.push(`${seconds}s`);
                
                return parts.length > 0 ? parts.join(' ') : '0s';
            }
            
            // Create the HTML content
            let html = `
                <div class="info-section">
                    <div class="section-header" onclick="toggleSection('all-tokens')">
                        <h2 style="margin: 0;">All Internally Issued Tokens</h2>
                        <span class="collapse-icon" id="all-tokens-icon">â–¼</span>
                    </div>
                    <div class="section-content active" id="all-tokens">
            `;
            
            if (data.tokens && data.tokens.length > 0) {
                // Create summary statistics
                const now = new Date();
                const revokedTokens = data.tokens.filter(t => t.revoked).length;
                const activeTokens = data.tokens.filter(t => !t.revoked && new Date(t.expires_at) > now).length;
                const expiredTokens = data.tokens.filter(t => !t.revoked && new Date(t.expires_at) <= now).length;
                
                html += `
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 16px; margin-bottom: 24px;">
                        <div class="stat-card" style="background-color: #e6f7ff; border-color: #91d5ff;">
                            <h3 style="color: var(--primary-color);">${data.tokens.length}</h3>
                            <p>Total Tokens</p>
                        </div>
                        <div class="stat-card" style="background-color: #f6ffed; border-color: #b7eb8f;">
                            <h3 style="color: var(--success-color);">${activeTokens}</h3>
                            <p>Active Tokens</p>
                        </div>
                        <div class="stat-card" style="background-color: #fff1f0; border-color: #ffccc7;">
                            <h3 style="color: var(--error-color);">${expiredTokens}</h3>
                            <p>Expired Tokens</p>
                        </div>
                        <div class="stat-card" style="background-color: #f0f0f0; border-color: #d9d9d9;">
                            <h3 style="color: rgba(0, 0, 0, 0.85);">${revokedTokens}</h3>
                            <p>Revoked Tokens</p>
                        </div>
                    </div>
                `;
                
                // Create table for tokens
                html += `
                    <div style="overflow-x: auto;">
                        <table>
                            <thead>
                                <tr>
                                    <th>#</th>
                                    <th>User</th>
                                    <th>Email</th>
                                    <th>Issued</th>
                                    <th>Expires</th>
                                    <th>Status</th>
                                    <th>Source</th>
                                    <th style="text-align: center;">Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                `;
                
                data.tokens.forEach((tokenInfo, index) => {
                    console.log(`Token ${index} timestamps:`, {
                        issued_at_raw: tokenInfo.issued_at,
                        expires_at_raw: tokenInfo.expires_at
                    });
                    
                    const issuedDate = new Date(tokenInfo.issued_at);
                    const expiryDate = new Date(tokenInfo.expires_at);
                    const now = new Date();
                    const isExpired = expiryDate <= now;
                    const isRevoked = tokenInfo.revoked || false;
                    
                    console.log(`Token ${index} parsed dates:`, {
                        issuedDate: issuedDate.toISOString(),
                        expiryDate: expiryDate.toISOString(),
                        now: now.toISOString(),
                        isExpired: isExpired,
                        isRevoked: isRevoked
                    });
                    
                    // Calculate time difference in milliseconds
                    const timeUntilExpiry = expiryDate.getTime() - now.getTime();
                    const timeDuration = formatTimeDuration(timeUntilExpiry);
                    
                    let statusBadge;
                    if (isRevoked) {
                        const revokedDate = tokenInfo.revoked_at ? new Date(tokenInfo.revoked_at) : null;
                        const timeSinceRevoked = revokedDate ? formatTimeDuration(now.getTime() - revokedDate.getTime()) : '';
                        statusBadge = `<span class="status" style="background-color: #f0f0f0; color: rgba(0, 0, 0, 0.65); border: 1px solid #d9d9d9;">Revoked${timeSinceRevoked ? ` ${timeSinceRevoked} ago` : ''}</span>`;
                    } else if (isExpired) {
                        statusBadge = `<span class="status" style="background-color: #fff2e8; color: var(--warning-color); border: 1px solid #ffbb96;">Expired ${timeDuration} ago</span>`;
                    } else {
                        statusBadge = `<span class="status authenticated">Active (${timeDuration} left)</span>`;
                    }
                    
                    html += `
                        <tr>
                            <td>${index + 1}</td>
                            <td style="font-weight: 500;">${tokenInfo.user?.name || 'N/A'}</td>
                            <td style="color: var(--text-secondary);">${tokenInfo.user?.email || 'N/A'}</td>
                            <td title="${formatDateUTC(issuedDate)}">${formatDateEST(issuedDate)}</td>
                            <td title="${formatDateUTC(expiryDate)}">${formatDateEST(expiryDate)}</td>
                            <td>${statusBadge}</td>
                            <td style="text-align: center;">${tokenInfo.source || 'unknown'}</td>
                            <td style="text-align: center;">
                                <button onclick="showTokenDetails(${index})" class="action-button">View Details</button>
                                <button onclick="showTokenActivityLog('${tokenInfo.id}')" class="action-button success">View Log</button>
                                ${isRevoked 
                                    ? '<button class="action-button" disabled>Revoked</button>'
                                    : `<button onclick="revokeToken('${tokenInfo.id}')" class="action-button danger">Revoke</button>`
                                }
                            </td>
                        </tr>
                    `;
                });
                
                html += `
                            </tbody>
                        </table>
                    </div>
                `;
                
                // Add hidden divs to store token details
                html += '<div id="token-details-storage" style="display: none;">';
                data.tokens.forEach((tokenInfo, index) => {
                    html += `<div id="token-detail-${index}">${JSON.stringify(tokenInfo, null, 2)}</div>`;
                });
                html += '</div>';
                
            } else {
                html += '<p>No tokens found or you do not have permission to view this information.</p>';
            }
            
            html += `
                    </div>
                </div>
            `;
            
            tokenListContainer.innerHTML = html;
            mainContent.appendChild(tokenListContainer);
            
            // Scroll to the new container
            tokenListContainer.scrollIntoView({behavior: 'smooth', block: 'start'});
        }
        
        function decodeJWT(token) {
            try {
                // Base64url decode function (JWT uses base64url, not base64)
                function base64urlDecode(str) {
                    // Replace base64url characters with base64 characters
                    str = str.replace(/-/g, '+').replace(/_/g, '/');
                    // Add padding if necessary
                    while (str.length % 4) {
                        str += '=';
                    }
                    // Decode base64
                    return atob(str);
                }
                
                const parts = token.split('.');
                if (parts.length !== 3) {
                    console.error('Invalid JWT format - expected 3 parts, got', parts.length);
                    return null;
                }
                
                // Decode header and payload using base64url
                const header = JSON.parse(base64urlDecode(parts[0]));
                const payload = JSON.parse(base64urlDecode(parts[1]));
                
                return {
                    header: header,
                    payload: payload,
                    signature: parts[2]
                };
            } catch (e) {
                console.error('Failed to decode JWT:', e);
                console.error('Token:', token);
                return null;
            }
        }
        
        function showTokenDetails(index) {
            const tokenDetail = document.getElementById(`token-detail-${index}`);
            if (tokenDetail) {
                const tokenData = JSON.parse(tokenDetail.textContent);
                
                // Debug logging
                console.log('Token data:', tokenData);
                console.log('Access token:', tokenData.access_token);
                
                // Decode the access token
                const decodedToken = tokenData.access_token ? decodeJWT(tokenData.access_token) : null;
                
                // Create modal overlay
                const modal = document.createElement('div');
                modal.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background-color: rgba(0, 0, 0, 0.5);
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    z-index: 2000;
                `;
                
                // Create modal content
                const modalContent = document.createElement('div');
                modalContent.style.cssText = `
                    background-color: white;
                    padding: 30px;
                    border-radius: 8px;
                    max-width: 900px;
                    width: 90%;
                    max-height: 80vh;
                    overflow-y: auto;
                    position: relative;
                    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
                `;
                
                // Format token display - always show encoded token
                let tokenDisplay = `
                    <div style="margin-bottom: 30px;">
                        <h4 style="margin-bottom: 10px; color: #0078D4;">Encoded JWT Token</h4>
                        <div style="background-color: #f5f5f5; padding: 15px; border-radius: 4px; overflow-x: auto; word-break: break-all; font-family: monospace; font-size: 12px;">
                            ${tokenData.access_token || 'No access token found'}
                        </div>
                    </div>
                `;
                
                if (decodedToken) {
                    tokenDisplay += `
                        <div style="margin-bottom: 20px;">
                            <h4 style="margin-bottom: 10px; color: #0078D4;">Decoded JWT Token</h4>
                            
                            <div style="margin-bottom: 15px;">
                                <h5 style="margin-bottom: 5px; color: #333;">Header</h5>
                                <pre style="background-color: #e8f4f8; padding: 15px; border-radius: 4px; overflow-x: auto; font-size: 12px; margin: 0;">${JSON.stringify(decodedToken.header, null, 2)}</pre>
                            </div>
                            
                            <div style="margin-bottom: 15px;">
                                <h5 style="margin-bottom: 5px; color: #333;">Payload</h5>
                                <pre style="background-color: #e8f8e8; padding: 15px; border-radius: 4px; overflow-x: auto; font-size: 12px; margin: 0;">${JSON.stringify(decodedToken.payload, null, 2)}</pre>
                            </div>
                            
                            <div style="margin-bottom: 15px;">
                                <h5 style="margin-bottom: 5px; color: #333;">Signature</h5>
                                <div style="background-color: #f8e8e8; padding: 15px; border-radius: 4px; overflow-x: auto; word-break: break-all; font-family: monospace; font-size: 12px;">
                                    ${decodedToken.signature}
                                </div>
                            </div>
                        </div>
                    `;
                } else {
                    tokenDisplay += `
                        <div style="margin-bottom: 20px; padding: 15px; background-color: #f8d7da; border-radius: 4px;">
                            <p style="color: #721c24; margin: 0;">Failed to decode JWT token. The token may be malformed or use a different encoding.</p>
                        </div>
                    `;
                }
                
                modalContent.innerHTML = `
                    <button onclick="this.closest('div').parentElement.remove()" style="position: absolute; top: 10px; right: 10px; background: none; border: none; font-size: 24px; cursor: pointer;">&times;</button>
                    <h3 style="margin-top: 0; margin-bottom: 20px;">Token Details</h3>
                    
                    ${tokenDisplay}
                    
                    <div style="margin-top: 30px;">
                        <h4 style="margin-bottom: 10px; color: #0078D4;">Full Token Information</h4>
                        <pre style="background-color: #f5f5f5; padding: 15px; border-radius: 4px; overflow-x: auto; font-size: 12px;">${JSON.stringify(tokenData, null, 2)}</pre>
                    </div>
                `;
                
                modal.appendChild(modalContent);
                document.body.appendChild(modal);
                
                // Close modal when clicking outside
                modal.addEventListener('click', function(e) {
                    if (e.target === modal) {
                        modal.remove();
                    }
                });
            }
        }
        
        async function revokeToken(tokenId) {
            // Show confirmation dialog
            if (!confirm(`Are you sure you want to revoke this token?\n\nToken ID: ${tokenId}\n\nThis action cannot be undone.`)) {
                return;
            }
            
            try {
                // Get the access token from localStorage (stored by viewAllTokens function)
                const accessToken = localStorage.getItem('access_token');
                
                if (!accessToken) {
                    // If not in localStorage, try to get it from session
                    const tokenResponse = await fetch('/auth/token/session', {
                        method: 'POST',
                        credentials: 'include'
                    });
                    
                    if (!tokenResponse.ok) {
                        showResponse('Error', {error: 'Not authenticated. Please login first.'});
                        return;
                    }
                    
                    const tokenData = await tokenResponse.json();
                    localStorage.setItem('access_token', tokenData.access_token);
                }
                
                // Call the revoke endpoint
                const response = await fetch(`/auth/admin/tokens/${tokenId}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('access_token')}`
                    },
                    credentials: 'include'
                });
                
                if (response.ok) {
                    // Show success message
                    showResponse('Success', {
                        status: 'success',
                        message: `Token ${tokenId} has been revoked successfully.`
                    });
                    
                    // Refresh the token list after a short delay
                    setTimeout(() => {
                        viewAllTokens();
                    }, 1500);
                } else {
                    const errorData = await response.json();
                    showResponse('Error', {
                        status: response.status,
                        statusText: response.statusText,
                        detail: errorData.detail || 'Failed to revoke token'
                    });
                }
            } catch (error) {
                showResponse('Error', {error: error.message});
            }
        }
        
        async function showTokenActivityLog(tokenId) {
            try {
                // Get the access token from localStorage or session
                let accessToken = localStorage.getItem('access_token');
                
                if (!accessToken) {
                    // If not in localStorage, try to get it from session
                    const tokenResponse = await fetch('/auth/token/session', {
                        method: 'POST',
                        credentials: 'include'
                    });
                    
                    if (!tokenResponse.ok) {
                        showResponse('Error', {error: 'Not authenticated. Please login first.'});
                        return;
                    }
                    
                    const tokenData = await tokenResponse.json();
                    accessToken = tokenData.access_token;
                    localStorage.setItem('access_token', accessToken);
                }
                
                // Fetch token activities
                const response = await fetch(`/auth/admin/tokens/${tokenId}/activities`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${accessToken}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    showActivityLogModal(tokenId, data);
                } else {
                    const errorData = await response.json();
                    showResponse('Error', {
                        status: response.status,
                        statusText: response.statusText,
                        detail: errorData.detail || 'Failed to fetch activity log'
                    });
                }
            } catch (error) {
                showResponse('Error', {error: error.message});
            }
        }
        
        function showActivityLogModal(tokenId, data) {
            // Create modal overlay
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background-color: rgba(0, 0, 0, 0.5);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 2000;
            `;
            
            // Create modal content
            const modalContent = document.createElement('div');
            modalContent.style.cssText = `
                background-color: white;
                padding: 30px;
                border-radius: 8px;
                max-width: 900px;
                width: 90%;
                max-height: 80vh;
                overflow-y: auto;
                position: relative;
                box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            `;
            
            // Format activities
            let activitiesHtml = '';
            if (data.activities && data.activities.length > 0) {
                activitiesHtml = `
                    <table style="width: 100%; border-collapse: collapse; margin-top: 20px;">
                        <thead>
                            <tr style="background-color: #f8f9fa; border-bottom: 2px solid #dee2e6;">
                                <th style="padding: 12px; text-align: left;">Timestamp</th>
                                <th style="padding: 12px; text-align: left;">Action</th>
                                <th style="padding: 12px; text-align: left;">Performed By</th>
                                <th style="padding: 12px; text-align: left;">Details</th>
                                <th style="padding: 12px; text-align: left;">IP Address</th>
                            </tr>
                        </thead>
                        <tbody>
                `;
                
                data.activities.forEach((activity, index) => {
                    const timestamp = new Date(activity.timestamp);
                    const rowStyle = index % 2 === 0 ? 'background-color: #ffffff;' : 'background-color: #f8f9fa;';
                    
                    // Format action with color coding
                    let actionBadge = activity.action;
                    let badgeColor = '#6c757d';
                    switch(activity.action) {
                        case 'created': badgeColor = '#28a745'; break;
                        case 'validated': badgeColor = '#17a2b8'; break;
                        case 'refreshed': badgeColor = '#ffc107'; break;
                        case 'revoked': badgeColor = '#dc3545'; break;
                        case 'admin_view': badgeColor = '#6610f2'; break;
                    }
                    
                    activitiesHtml += `
                        <tr style="${rowStyle} border-bottom: 1px solid #dee2e6;">
                            <td style="padding: 12px; font-size: 14px;">${formatDateEST(timestamp)}</td>
                            <td style="padding: 12px;">
                                <span style="display: inline-block; padding: 4px 8px; background-color: ${badgeColor}; color: white; border-radius: 4px; font-size: 12px;">${activity.action}</span>
                            </td>
                            <td style="padding: 12px; font-size: 14px;">${activity.performed_by ? activity.performed_by.email : 'System'}</td>
                            <td style="padding: 12px; font-size: 14px;">${JSON.stringify(activity.details || {})}</td>
                            <td style="padding: 12px; font-size: 14px;">${activity.ip_address || 'N/A'}</td>
                        </tr>
                    `;
                });
                
                activitiesHtml += `
                        </tbody>
                    </table>
                `;
            } else {
                activitiesHtml = '<p style="margin-top: 20px;">No activities logged for this token.</p>';
            }
            
            modalContent.innerHTML = `
                <button onclick="this.closest('div').parentElement.remove()" style="position: absolute; top: 10px; right: 10px; background: none; border: none; font-size: 24px; cursor: pointer;">&times;</button>
                <h3 style="margin-top: 0; margin-bottom: 10px;">Token Activity Log</h3>
                <div style="background-color: #f5f5f5; padding: 15px; border-radius: 4px; margin-bottom: 20px;">
                    <p style="margin: 0;"><strong>Token ID:</strong> ${tokenId}</p>
                    <p style="margin: 5px 0 0 0;"><strong>User:</strong> ${data.token_info.user.name} (${data.token_info.user.email})</p>
                    <p style="margin: 5px 0 0 0;"><strong>Issued:</strong> ${formatDateEST(new Date(data.token_info.issued_at))}</p>
                    <p style="margin: 5px 0 0 0;"><strong>Status:</strong> ${data.token_info.revoked ? '<span style="color: #dc3545;">Revoked</span>' : '<span style="color: #28a745;">Active</span>'}</p>
                    <p style="margin: 5px 0 0 0;"><strong>Total Activities:</strong> ${data.activity_count}</p>
                </div>
                ${activitiesHtml}
            `;
            
            modal.appendChild(modalContent);
            document.body.appendChild(modal);
            
            // Close modal when clicking outside
            modal.addEventListener('click', function(e) {
                if (e.target === modal) {
                    modal.remove();
                }
            });
            
            // Helper function to format date in EST
            function formatDateEST(utcDate) {
                const options = {
                    timeZone: 'America/New_York',
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit',
                    hour12: true,
                    timeZoneName: 'short'
                };
                return utcDate.toLocaleString('en-US', options);
            }
        }
        
        // Global helper function to format date in EST
        function formatDateEST(dateInput) {
            // Handle both Date objects and ISO strings
            const date = typeof dateInput === 'string' ? new Date(dateInput) : dateInput;
            const options = {
                timeZone: 'America/New_York',
                year: 'numeric',
                month: 'short',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit',
                hour12: true,
                timeZoneName: 'short'
            };
            return date.toLocaleString('en-US', options);
        }
        
        async function showAzureTokenActivityLog(tokenId) {
            console.log('showAzureTokenActivityLog called with tokenId:', tokenId);
            try {
                // Get the access token from localStorage or session
                let accessToken = localStorage.getItem('access_token');
                
                if (!accessToken) {
                    // If not in localStorage, try to get it from session
                    const tokenResponse = await fetch('/auth/token/session', {
                        method: 'POST',
                        credentials: 'include'
                    });
                    
                    if (!tokenResponse.ok) {
                        showResponse('Error', {error: 'Not authenticated. Please login first.'});
                        return;
                    }
                    
                    const tokenData = await tokenResponse.json();
                    accessToken = tokenData.access_token;
                    localStorage.setItem('access_token', accessToken);
                }
                
                // Fetch token activities
                console.log('Fetching activities for token:', tokenId);
                const url = `/auth/admin/azure-tokens/${tokenId}/activities`;
                console.log('Fetching from URL:', url);
                const response = await fetch(url, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${accessToken}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                console.log('Response status:', response.status);
                if (response.ok) {
                    const data = await response.json();
                    console.log('Got activity data:', data);
                    showAzureActivityLogModal(tokenId, data);
                } else {
                    const errorData = await response.json();
                    console.log('Error response:', errorData);
                    showResponse('Error', {
                        status: response.status,
                        statusText: response.statusText,
                        detail: errorData.detail || 'Failed to fetch activity log'
                    });
                }
            } catch (error) {
                console.error('Error in showAzureTokenActivityLog:', error);
                showResponse('Error', {error: error.message});
                alert('Error in showAzureTokenActivityLog: ' + error.message);
            }
        }
        
        function showAzureActivityLogModal(tokenId, data) {
            // Create modal overlay
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background-color: rgba(0, 0, 0, 0.5);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 2000;
            `;
            
            // Create modal content
            const modalContent = document.createElement('div');
            modalContent.style.cssText = `
                background-color: white;
                padding: 30px;
                border-radius: 8px;
                max-width: 900px;
                width: 90%;
                max-height: 80vh;
                overflow-y: auto;
                position: relative;
                box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            `;
            
            // Format activities
            let activitiesHtml = '';
            if (data.activities && data.activities.length > 0) {
                activitiesHtml = `
                    <table style="width: 100%; border-collapse: collapse; margin-top: 20px;">
                        <thead>
                            <tr style="background-color: #f8f9fa; border-bottom: 2px solid #dee2e6;">
                                <th style="padding: 12px; text-align: left;">Timestamp</th>
                                <th style="padding: 12px; text-align: left;">Action</th>
                                <th style="padding: 12px; text-align: left;">Performed By</th>
                                <th style="padding: 12px; text-align: left;">Details</th>
                                <th style="padding: 12px; text-align: left;">IP Address</th>
                            </tr>
                        </thead>
                        <tbody>
                `;
                
                data.activities.forEach((activity, index) => {
                    const timestamp = new Date(activity.timestamp);
                    const rowStyle = index % 2 === 0 ? 'background-color: #ffffff;' : 'background-color: #f8f9fa;';
                    
                    // Format action with color coding
                    let actionBadge = activity.action;
                    let actionColor = '#6c757d';
                    
                    switch(activity.action) {
                        case 'created':
                            actionColor = '#28a745';
                            break;
                        case 'refreshed':
                            actionColor = '#17a2b8';
                            break;
                        case 'validated':
                            actionColor = '#007bff';
                            break;
                        case 'revoked':
                            actionColor = '#dc3545';
                            break;
                        case 'admin_view':
                            actionColor = '#ffc107';
                            break;
                        case 'admin_action':
                            actionColor = '#fd7e14';
                            break;
                    }
                    
                    actionBadge = `<span style="background-color: ${actionColor}; color: white; padding: 2px 8px; border-radius: 4px; font-size: 12px;">${activity.action}</span>`;
                    
                    // Format performed by
                    const performedBy = activity.performed_by ? 
                        `${activity.performed_by.name || ''}<br><small style="color: #666;">${activity.performed_by.email || ''}</small>` : 
                        '<span style="color: #999;">System</span>';
                    
                    // Format details
                    let details = '';
                    if (activity.details && Object.keys(activity.details).length > 0) {
                        details = Object.entries(activity.details)
                            .map(([key, value]) => `<small><strong>${key}:</strong> ${value}</small>`)
                            .join('<br>');
                    }
                    
                    activitiesHtml += `
                        <tr style="${rowStyle} border-bottom: 1px solid #dee2e6;">
                            <td style="padding: 12px; font-size: 14px;">${formatDateEST(timestamp)}</td>
                            <td style="padding: 12px;">${actionBadge}</td>
                            <td style="padding: 12px; font-size: 14px;">${performedBy}</td>
                            <td style="padding: 12px; font-size: 13px;">${details}</td>
                            <td style="padding: 12px; font-size: 13px; color: #666;">${activity.ip_address || '-'}</td>
                        </tr>
                    `;
                });
                
                activitiesHtml += `
                        </tbody>
                    </table>
                `;
            } else {
                activitiesHtml = '<p style="margin-top: 20px; color: #666;">No activities recorded for this token.</p>';
            }
            
            modalContent.innerHTML = `
                <h3 style="margin-top: 0; color: #0078D4;">Azure Token Activity Log</h3>
                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; margin-top: 20px;">
                    <div>
                        <h4 style="margin-bottom: 10px; color: #333;">Token Information</h4>
                        <p style="margin: 5px 0;"><strong>Token ID:</strong> <code style="background-color: #f8f9fa; padding: 2px 6px; border-radius: 3px;">${tokenId}</code></p>
                        ${data.token_info ? `
                            <p style="margin: 5px 0;"><strong>User:</strong> ${data.token_info.user?.name || 'N/A'}</p>
                            <p style="margin: 5px 0;"><strong>Email:</strong> ${data.token_info.user?.email || 'N/A'}</p>
                            <p style="margin: 5px 0;"><strong>Issued:</strong> ${formatDateEST(new Date(data.token_info.issued_at))}</p>
                            <p style="margin: 5px 0;"><strong>Expires:</strong> ${formatDateEST(new Date(data.token_info.expires_at))}</p>
                        ` : ''}
                    </div>
                    <div>
                        <h4 style="margin-bottom: 10px; color: #333;">Activity Summary</h4>
                        <p style="margin: 5px 0;"><strong>Total Activities:</strong> ${data.activity_count || 0}</p>
                        ${data.token_info ? `
                            <p style="margin: 5px 0;"><strong>Issuer:</strong> <small>${data.token_info.issuer || 'N/A'}</small></p>
                            <p style="margin: 5px 0;"><strong>Audience:</strong> <small>${data.token_info.audience || 'N/A'}</small></p>
                        ` : ''}
                    </div>
                </div>
                
                <h4 style="margin-top: 30px; margin-bottom: 10px; color: #333;">Activity Details</h4>
                ${activitiesHtml}
                
                <button onclick="this.parentElement.parentElement.remove()" style="position: absolute; top: 10px; right: 10px; background: none; border: none; font-size: 24px; cursor: pointer; color: #999;">&times;</button>
            `;
            
            modal.appendChild(modalContent);
            document.body.appendChild(modal);
            
            // Close modal when clicking outside
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.remove();
                }
            });
        }
        
        // Global variable for auto-refresh interval
        let autoRefreshInterval = null;
        
        // URL routing support
        function updateURL(path) {
            const newURL = window.location.origin + path;
            window.history.pushState({ path: path }, '', newURL);
        }
        
        // Handle browser back/forward buttons
        window.addEventListener('popstate', (event) => {
            if (event.state && event.state.path) {
                navigateToPath(event.state.path);
            }
        });
        
        function navigateToPath(path) {
            if (path === '/admin' || path === '/admin/tokens') {
                viewAdministration().then(() => showTokenManagement());
            } else if (path === '/admin/apps') {
                viewAdministration().then(() => showAppManagement());
            }
            // Default is home page, no action needed
        }
        
        async function viewAdministration() {
            try {
                // Update URL
                updateURL('/admin');
                
                // Clear the main content first
                const mainContent = document.getElementById('main-content');
                mainContent.innerHTML = '<div style="text-align: center; padding: 40px;"><div class="spinner"></div><p>Loading administration panel...</p></div>';
                
                // Get the access token
                const tokenResponse = await fetch('/auth/token/session', {
                    method: 'POST',
                    credentials: 'include'
                });
                
                if (!tokenResponse.ok) {
                    showResponse('Error', {error: 'Not authenticated. Please login first.'});
                    return;
                }
                
                const tokenData = await tokenResponse.json();
                const accessToken = tokenData.access_token;
                localStorage.setItem('access_token', accessToken);
                
                // Fetch both internal and Azure tokens in parallel
                const [internalResponse, azureResponse] = await Promise.all([
                    fetch('/auth/admin/tokens', {
                        method: 'GET',
                        headers: {
                            'Authorization': `Bearer ${accessToken}`
                        },
                        credentials: 'include'
                    }),
                    fetch('/auth/admin/azure-tokens', {
                        method: 'GET',
                        headers: {
                            'Authorization': `Bearer ${accessToken}`
                        },
                        credentials: 'include'
                    })
                ]);
                
                if (internalResponse.ok && azureResponse.ok) {
                    const internalData = await internalResponse.json();
                    const azureData = await azureResponse.json();
                    showUnifiedTokenView(internalData, azureData);
                } else {
                    let errorMsg = 'Failed to fetch tokens.';
                    if (!internalResponse.ok) {
                        const internalError = await internalResponse.json();
                        errorMsg += ` Internal tokens: ${internalError.detail || internalResponse.statusText}.`;
                    }
                    if (!azureResponse.ok) {
                        const azureError = await azureResponse.json();
                        errorMsg += ` Azure tokens: ${azureError.detail || azureResponse.statusText}.`;
                    }
                    showResponse('Error', {error: errorMsg});
                }
            } catch (error) {
                showResponse('Error', {error: error.message});
            }
        }
        
        async function refreshTokenList() {
            // Check if we're on the administration page
            const adminContainer = document.querySelector('h2 span');
            if (!adminContainer || adminContainer.textContent !== 'Token Administration') {
                return;
            }
            
            // Show loading indicator
            const refreshButton = document.querySelector('button[onclick="refreshTokenList()"]');
            if (refreshButton) {
                refreshButton.disabled = true;
                refreshButton.textContent = 'Refreshing...';
            }
            
            try {
                const accessToken = localStorage.getItem('access_token');
                if (!accessToken) {
                    showResponse('Error', {error: 'Not authenticated. Please login first.'});
                    return;
                }
                
                // Fetch both internal and Azure tokens in parallel
                const [internalResponse, azureResponse] = await Promise.all([
                    fetch('/auth/admin/tokens', {
                        method: 'GET',
                        headers: {
                            'Authorization': `Bearer ${accessToken}`
                        },
                        credentials: 'include'
                    }),
                    fetch('/auth/admin/azure-tokens', {
                        method: 'GET',
                        headers: {
                            'Authorization': `Bearer ${accessToken}`
                        },
                        credentials: 'include'
                    })
                ]);
                
                if (internalResponse.ok && azureResponse.ok) {
                    const internalData = await internalResponse.json();
                    const azureData = await azureResponse.json();
                    
                    // Preserve current search/filter state
                    const currentSearch = document.getElementById('tokenSearchInput')?.value || '';
                    const currentTypeFilter = document.getElementById('typeFilter')?.value || '';
                    const currentStatusFilter = document.getElementById('statusFilter')?.value || '';
                    const currentAutoRefresh = document.getElementById('autoRefreshCheckbox')?.checked || false;
                    
                    // Update the view
                    showUnifiedTokenView(internalData, azureData);
                    
                    // Restore search/filter state
                    if (document.getElementById('tokenSearchInput')) {
                        document.getElementById('tokenSearchInput').value = currentSearch;
                    }
                    if (document.getElementById('typeFilter')) {
                        document.getElementById('typeFilter').value = currentTypeFilter;
                    }
                    if (document.getElementById('statusFilter')) {
                        document.getElementById('statusFilter').value = currentStatusFilter;
                    }
                    if (document.getElementById('autoRefreshCheckbox')) {
                        document.getElementById('autoRefreshCheckbox').checked = currentAutoRefresh;
                    }
                    
                    // Apply filters if any were active
                    if (currentSearch || currentTypeFilter || currentStatusFilter) {
                        filterTokens();
                    }
                    
                    // Show success message briefly
                    const timestamp = new Date().toLocaleTimeString();
                    console.log(`Token list refreshed at ${timestamp}`);
                } else {
                    console.error('Failed to refresh token list');
                }
            } catch (error) {
                console.error('Error refreshing token list:', error);
            } finally {
                // Re-enable refresh button
                if (refreshButton) {
                    refreshButton.disabled = false;
                    refreshButton.textContent = 'Refresh';
                }
            }
        }
        
        function toggleAutoRefresh() {
            const checkbox = document.getElementById('autoRefreshCheckbox');
            if (!checkbox) return;
            
            if (checkbox.checked) {
                // Start auto-refresh
                autoRefreshInterval = setInterval(() => {
                    refreshTokenList();
                }, 30000); // 30 seconds
                console.log('Auto-refresh enabled (30 second interval)');
            } else {
                // Stop auto-refresh
                if (autoRefreshInterval) {
                    clearInterval(autoRefreshInterval);
                    autoRefreshInterval = null;
                    console.log('Auto-refresh disabled');
                }
            }
        }
        
        // Clean up auto-refresh when leaving the page
        window.addEventListener('beforeunload', () => {
            if (autoRefreshInterval) {
                clearInterval(autoRefreshInterval);
            }
        });
        
        function showUnifiedTokenView(internalData, azureData) {
            const mainContent = document.getElementById('main-content');
            mainContent.innerHTML = '';
            
            // Combine all tokens into a single array with type indicator
            const allTokens = [];
            
            // Add internal tokens
            if (internalData.tokens) {
                internalData.tokens.forEach(token => {
                    allTokens.push({
                        ...token,
                        type: 'Internal',
                        typeColor: '#28a745',
                        userName: token.user?.name || 'N/A',
                        userEmail: token.user?.email || 'N/A',
                        issuer: 'Auth Service',
                        audience: 'Internal',
                        tokenId: token.id
                    });
                });
            }
            
            // Add Azure tokens
            if (azureData.tokens) {
                azureData.tokens.forEach(token => {
                    allTokens.push({
                        ...token,
                        type: 'Azure AD',
                        typeColor: '#0078D4',
                        userName: token.user?.name || 'N/A',
                        userEmail: token.user?.email || 'N/A',
                        issuer: token.issuer || 'Microsoft',
                        audience: token.audience || 'Azure',
                        tokenId: token.id
                    });
                });
            }
            
            // Sort by issued date (newest first)
            allTokens.sort((a, b) => new Date(b.issued_at) - new Date(a.issued_at));
            
            // Create the unified view
            const container = document.createElement('div');
            container.style.cssText = 'padding: 20px; max-width: 100%; overflow-x: auto;';
            
            let html = `
                <h2 style="color: #333; margin-bottom: 20px;">Administration</h2>
                
                <!-- Tab Navigation -->
                <div style="display: flex; gap: 10px; margin-bottom: 20px; border-bottom: 2px solid #ddd; padding-bottom: 0;">
                    <button onclick="showTokenManagement()" id="tokenTab" style="padding: 10px 20px; background: #0078D4; color: white; border: none; border-radius: 4px 4px 0 0; cursor: pointer; font-weight: 500;">
                        Token Management
                    </button>
                    <button onclick="showAppManagement()" id="appTab" style="padding: 10px 20px; background: #f0f0f0; color: #333; border: none; border-radius: 4px 4px 0 0; cursor: pointer; font-weight: 500;">
                        App Registration
                    </button>
                </div>
                
                <div id="adminContent">
                    <h3 style="color: #333; margin-bottom: 20px; display: flex; align-items: center; justify-content: space-between;">
                        <span>Token Management</span>
                        <div style="display: flex; align-items: center; gap: 20px;">
                            <div style="font-size: 14px; color: #666;">
                                <span style="margin-right: 20px;">Total Tokens: ${allTokens.length}</span>
                                <span style="margin-right: 20px;">Internal: ${internalData.tokens ? internalData.tokens.length : 0}</span>
                            <span>Azure: ${azureData.tokens ? azureData.tokens.length : 0}</span>
                        </div>
                        <button onclick="refreshTokenList()" style="padding: 6px 12px; background-color: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 14px;">
                            Refresh
                        </button>
                        <label style="display: flex; align-items: center; font-size: 14px; color: #495057; cursor: pointer;">
                            <input type="checkbox" id="autoRefreshCheckbox" onchange="toggleAutoRefresh()" style="margin-right: 5px;">
                            Auto-refresh (30s)
                        </label>
                    </div>
                </h3>
                
                <!-- Search and Filter Section -->
                <div style="background-color: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                    <div style="display: grid; grid-template-columns: 1fr auto; gap: 15px; align-items: end;">
                        <div>
                            <label style="display: block; margin-bottom: 5px; font-weight: 500; color: #555;">Search tokens:</label>
                            <input type="text" id="tokenSearchInput" placeholder="Search by any field..." 
                                style="width: 100%; padding: 8px 12px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px;"
                                onkeyup="filterTokens()">
                        </div>
                        <div style="display: flex; gap: 10px;">
                            <select id="typeFilter" onchange="filterTokens()" style="padding: 8px 12px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px;">
                                <option value="">All Types</option>
                                <option value="Internal">Internal Only</option>
                                <option value="Azure AD">Azure AD Only</option>
                            </select>
                            <select id="statusFilter" onchange="filterTokens()" style="padding: 8px 12px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px;">
                                <option value="">All Status</option>
                                <option value="active">Active</option>
                                <option value="expired">Expired</option>
                                <option value="revoked">Revoked</option>
                            </select>
                            <button onclick="clearFilters()" style="padding: 8px 16px; background-color: #6c757d; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 14px;">
                                Clear Filters
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Tokens Table -->
                <div style="background-color: white; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); overflow: hidden;">
                    <table id="tokensTable" style="width: 100%; border-collapse: collapse;">
                        <thead>
                            <tr style="background-color: #f8f9fa; border-bottom: 2px solid #dee2e6;">
                                <th style="padding: 12px; text-align: left; font-weight: 600; color: #495057; cursor: pointer;" onclick="sortTable(0)">
                                    Type <span class="sort-indicator">â†•</span>
                                </th>
                                <th style="padding: 12px; text-align: left; font-weight: 600; color: #495057; cursor: pointer;" onclick="sortTable(1)">
                                    User <span class="sort-indicator">â†•</span>
                                </th>
                                <th style="padding: 12px; text-align: left; font-weight: 600; color: #495057; cursor: pointer;" onclick="sortTable(2)">
                                    Email <span class="sort-indicator">â†•</span>
                                </th>
                                <th style="padding: 12px; text-align: left; font-weight: 600; color: #495057; cursor: pointer;" onclick="sortTable(3)">
                                    Issued <span class="sort-indicator">â†•</span>
                                </th>
                                <th style="padding: 12px; text-align: left; font-weight: 600; color: #495057; cursor: pointer;" onclick="sortTable(4)">
                                    Expires <span class="sort-indicator">â†•</span>
                                </th>
                                <th style="padding: 12px; text-align: left; font-weight: 600; color: #495057;">Status</th>
                                <th style="padding: 12px; text-align: left; font-weight: 600; color: #495057;">Issuer</th>
                                <th style="padding: 12px; text-align: center; font-weight: 600; color: #495057;">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="tokensTableBody">
            `;
            
            // Add token rows
            allTokens.forEach((token, index) => {
                const issuedDate = new Date(token.issued_at);
                const expiresDate = new Date(token.expires_at);
                const now = new Date();
                
                let status = 'Active';
                let statusColor = '#28a745';
                if (token.revoked) {
                    status = 'Revoked';
                    statusColor = '#dc3545';
                } else if (expiresDate < now) {
                    status = 'Expired';
                    statusColor = '#ffc107';
                }
                
                const rowStyle = index % 2 === 0 ? 'background-color: #ffffff;' : 'background-color: #f8f9fa;';
                
                html += `
                    <tr class="token-row" style="${rowStyle} border-bottom: 1px solid #dee2e6;" 
                        data-type="${token.type}" 
                        data-status="${status.toLowerCase()}"
                        data-user="${token.userName.toLowerCase()}"
                        data-email="${token.userEmail.toLowerCase()}"
                        data-issuer="${token.issuer.toLowerCase()}"
                        data-token-id="${token.tokenId}">
                        <td style="padding: 12px;">
                            <span style="background-color: ${token.typeColor}; color: white; padding: 2px 8px; border-radius: 4px; font-size: 12px; font-weight: 500;">
                                ${token.type}
                            </span>
                        </td>
                        <td style="padding: 12px; font-weight: 500;">${token.userName}</td>
                        <td style="padding: 12px; font-size: 14px; color: #666;">${token.userEmail}</td>
                        <td style="padding: 12px; font-size: 14px;" title="${formatDateUTC(issuedDate)}">${formatDateEST(issuedDate)}</td>
                        <td style="padding: 12px; font-size: 14px;" title="${formatDateUTC(expiresDate)}">${formatDateEST(expiresDate)}</td>
                        <td style="padding: 12px;">
                            <span style="background-color: ${statusColor}; color: white; padding: 2px 8px; border-radius: 4px; font-size: 12px;">
                                ${status}
                            </span>
                        </td>
                        <td style="padding: 12px; font-size: 12px; color: #666;">${token.issuer}</td>
                        <td style="padding: 12px; text-align: center;">
                            <button onclick="viewTokenDetails('${token.type}', ${index})" style="background-color: #0078D4; color: white; border: none; padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 11px; margin: 2px;">Details</button>
                            <button onclick="viewTokenActivityLog('${token.type}', '${token.tokenId}')" style="background-color: #28a745; color: white; border: none; padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 11px; margin: 2px;">Log</button>
                            ${token.type === 'Internal' && !token.revoked ? 
                                `<button onclick="revokeToken('${token.tokenId}')" style="background-color: #dc3545; color: white; border: none; padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 11px; margin: 2px;">Revoke</button>` : 
                                `<button onclick="removeToken('${token.type}', '${token.tokenId}')" style="background-color: #dc3545; color: white; border: none; padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 11px; margin: 2px;">Remove</button>`
                            }
                        </td>
                    </tr>
                `;
            });
            
            html += `
                        </tbody>
                    </table>
                </div>
                
                <!-- Store token details for modal display -->
                <div id="unified-token-details-storage" style="display: none;">
            `;
            
            allTokens.forEach((token, index) => {
                html += `<div id="unified-token-detail-${index}">${JSON.stringify(token, null, 2)}</div>`;
            });
            
            html += '</div>';
            
            // Close adminContent div
            html += '</div>';
            
            container.innerHTML = html;
            mainContent.appendChild(container);
            
            // Store token data for tab switching
            window.adminTokenData = { internalData, azureData, allTokens };
            
            // Add the filter and sort functions to the window
            window.filterTokens = filterTokens;
            window.clearFilters = clearFilters;
            window.sortTable = sortTable;
            window.viewTokenDetails = viewTokenDetails;
            window.viewTokenActivityLog = viewTokenActivityLog;
            window.removeToken = removeToken;
            window.refreshTokenList = refreshTokenList;
            window.toggleAutoRefresh = toggleAutoRefresh;
            
            // Store tokens globally for filtering
            window.allTokensData = allTokens;
        }
        
        function filterTokens() {
            const searchInput = document.getElementById('tokenSearchInput').value.toLowerCase();
            const typeFilter = document.getElementById('typeFilter').value;
            const statusFilter = document.getElementById('statusFilter').value;
            const rows = document.querySelectorAll('.token-row');
            
            rows.forEach(row => {
                const type = row.getAttribute('data-type');
                const status = row.getAttribute('data-status');
                const user = row.getAttribute('data-user');
                const email = row.getAttribute('data-email');
                const issuer = row.getAttribute('data-issuer');
                const tokenId = row.getAttribute('data-token-id');
                
                let showRow = true;
                
                // Type filter
                if (typeFilter && type !== typeFilter) {
                    showRow = false;
                }
                
                // Status filter
                if (statusFilter && status !== statusFilter) {
                    showRow = false;
                }
                
                // Search filter
                if (searchInput) {
                    const searchableText = `${type} ${user} ${email} ${issuer} ${tokenId}`.toLowerCase();
                    if (!searchableText.includes(searchInput)) {
                        showRow = false;
                    }
                }
                
                row.style.display = showRow ? '' : 'none';
            });
            
            // Update row colors
            let visibleIndex = 0;
            rows.forEach(row => {
                if (row.style.display !== 'none') {
                    row.style.backgroundColor = visibleIndex % 2 === 0 ? '#ffffff' : '#f8f9fa';
                    visibleIndex++;
                }
            });
        }
        
        function clearFilters() {
            document.getElementById('tokenSearchInput').value = '';
            document.getElementById('typeFilter').value = '';
            document.getElementById('statusFilter').value = '';
            filterTokens();
        }
        
        function sortTable(columnIndex) {
            const table = document.getElementById('tokensTable');
            const tbody = table.querySelector('tbody');
            const rows = Array.from(tbody.querySelectorAll('tr'));
            
            // Determine sort direction
            const isAscending = table.getAttribute('data-sort-column') === String(columnIndex) && 
                               table.getAttribute('data-sort-direction') === 'asc';
            
            // Sort rows
            rows.sort((a, b) => {
                let aValue, bValue;
                
                switch(columnIndex) {
                    case 0: // Type
                        aValue = a.getAttribute('data-type');
                        bValue = b.getAttribute('data-type');
                        break;
                    case 1: // User
                        aValue = a.getAttribute('data-user');
                        bValue = b.getAttribute('data-user');
                        break;
                    case 2: // Email
                        aValue = a.getAttribute('data-email');
                        bValue = b.getAttribute('data-email');
                        break;
                    case 3: // Issued
                    case 4: // Expires
                        const aToken = window.allTokensData.find(t => t.tokenId === a.getAttribute('data-token-id'));
                        const bToken = window.allTokensData.find(t => t.tokenId === b.getAttribute('data-token-id'));
                        aValue = new Date(columnIndex === 3 ? aToken.issued_at : aToken.expires_at);
                        bValue = new Date(columnIndex === 3 ? bToken.issued_at : bToken.expires_at);
                        break;
                    default:
                        return 0;
                }
                
                if (aValue < bValue) return isAscending ? -1 : 1;
                if (aValue > bValue) return isAscending ? 1 : -1;
                return 0;
            });
            
            // Update table
            rows.forEach(row => tbody.appendChild(row));
            
            // Update sort indicators
            table.setAttribute('data-sort-column', columnIndex);
            table.setAttribute('data-sort-direction', isAscending ? 'desc' : 'asc');
            
            // Update row colors
            rows.forEach((row, index) => {
                if (row.style.display !== 'none') {
                    row.style.backgroundColor = index % 2 === 0 ? '#ffffff' : '#f8f9fa';
                }
            });
        }
        
        function viewTokenDetails(type, index) {
            const tokenDetail = document.getElementById(`unified-token-detail-${index}`);
            if (tokenDetail) {
                const tokenData = JSON.parse(tokenDetail.textContent);
                
                // Create modal overlay
                const modal = document.createElement('div');
                modal.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background-color: rgba(0, 0, 0, 0.5);
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    z-index: 2000;
                `;
                
                // Create modal content
                const modalContent = document.createElement('div');
                modalContent.style.cssText = `
                    background-color: white;
                    padding: 30px;
                    border-radius: 8px;
                    max-width: 600px;
                    width: 90%;
                    max-height: 80vh;
                    overflow-y: auto;
                    position: relative;
                `;
                
                modalContent.innerHTML = `
                    <h3 style="margin-top: 0; color: ${tokenData.typeColor};">${tokenData.type} Token Details</h3>
                    <pre style="background-color: #f8f9fa; padding: 15px; border-radius: 4px; overflow-x: auto; font-size: 12px;">${JSON.stringify(tokenData, null, 2)}</pre>
                    <button onclick="this.parentElement.parentElement.remove()" style="position: absolute; top: 10px; right: 10px; background: none; border: none; font-size: 24px; cursor: pointer; color: #999;">&times;</button>
                `;
                
                modal.appendChild(modalContent);
                document.body.appendChild(modal);
                
                // Close modal when clicking outside
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) {
                        modal.remove();
                    }
                });
            }
        }
        
        function viewTokenActivityLog(type, tokenId) {
            if (type === 'Internal') {
                showTokenActivityLog(tokenId);
            } else {
                showAzureTokenActivityLog(tokenId);
            }
        }
        
        function removeToken(type, tokenId) {
            if (type === 'Azure AD') {
                removeAzureToken(tokenId);
            } else {
                // For internal tokens that are already revoked, we don't have a remove function
                alert('Revoked internal tokens cannot be removed from storage.');
            }
        }
        
        // Helper function to format date in UTC
        function formatDateUTC(date) {
            const options = {
                timeZone: 'UTC',
                year: 'numeric',
                month: 'short',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit',
                hour12: true
            };
            return date.toLocaleString('en-US', options) + ' UTC';
        }
        
        async function viewAllAzureTokens() {
            try {
                // First, get the access token from the session
                const tokenResponse = await fetch('/auth/token/session', {
                    method: 'POST',
                    credentials: 'include'
                });
                
                if (!tokenResponse.ok) {
                    showResponse('Error', {error: 'Not authenticated. Please login first.'});
                    return;
                }
                
                const tokenData = await tokenResponse.json();
                const accessToken = tokenData.access_token;
                
                // Store it in localStorage for future use
                localStorage.setItem('access_token', accessToken);
                
                // Now fetch all Azure tokens with the access token
                const response = await fetch('/auth/admin/azure-tokens', {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${accessToken}`
                    },
                    credentials: 'include'
                });
                
                if (!response.ok) {
                    const errorData = await response.json();
                    showResponse('Error', {
                        status: response.status,
                        statusText: response.statusText,
                        detail: errorData.detail || 'Failed to fetch Azure tokens'
                    });
                    return;
                }
                
                const data = await response.json();
                showAllAzureTokensResponse('All Azure AD Tokens', data);
            } catch (error) {
                showResponse('Error', {error: error.message});
            }
        }
        
        function showAllAzureTokensResponse(title, data) {
            // Remove existing Azure token list container if it exists
            const existingAzureTokenList = document.getElementById('azure-token-list-container');
            if (existingAzureTokenList) {
                existingAzureTokenList.remove();
            }
            
            // Create a new container for the Azure token list
            const mainContent = document.getElementById('main-content');
            const azureTokenListContainer = document.createElement('div');
            azureTokenListContainer.id = 'azure-token-list-container';
            azureTokenListContainer.className = 'container';
            azureTokenListContainer.style.marginTop = '20px';
            
            // Helper function to format date in UTC
            function formatDateUTC(isoDateStr) {
                const utcDate = new Date(isoDateStr);
                const options = {
                    timeZone: 'UTC',
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit',
                    hour12: true
                };
                return utcDate.toLocaleString('en-US', options) + ' UTC';
            }
            
            // Helper function to format date nicely with EST indicator
            function formatDateEST(isoDateStr) {
                const utcDate = new Date(isoDateStr);
                const options = {
                    timeZone: 'America/New_York',
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit',
                    hour12: true,
                    timeZoneName: 'short'
                };
                return utcDate.toLocaleString('en-US', options);
            }
            
            // Helper function to format time duration
            function formatTimeDuration(milliseconds) {
                const totalSeconds = Math.floor(Math.abs(milliseconds) / 1000);
                const days = Math.floor(totalSeconds / (24 * 3600));
                const hours = Math.floor((totalSeconds % (24 * 3600)) / 3600);
                const minutes = Math.floor((totalSeconds % 3600) / 60);
                const seconds = totalSeconds % 60;
                
                let parts = [];
                if (days > 0) parts.push(`${days}d`);
                if (hours > 0) parts.push(`${hours}h`);
                if (minutes > 0) parts.push(`${minutes}m`);
                if (seconds > 0 && days === 0) parts.push(`${seconds}s`);
                
                return parts.length > 0 ? parts.join(' ') : '0s';
            }
            
            // Create the HTML content
            let html = `
                <div class="info-section">
                    <div class="section-header" onclick="toggleSection('all-azure-tokens')">
                        <h2 style="margin: 0;">All Azure AD Tokens</h2>
                        <span class="collapse-icon" id="all-azure-tokens-icon">â–¼</span>
                    </div>
                    <div class="section-content active" id="all-azure-tokens">
            `;
            
            if (data.tokens && data.tokens.length > 0) {
                // Create summary statistics
                const now = new Date();
                const activeTokens = data.tokens.filter(t => new Date(t.expires_at) > now).length;
                const expiredTokens = data.tokens.filter(t => new Date(t.expires_at) <= now).length;
                
                html += `
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-bottom: 20px;">
                        <div style="background-color: #e7f3ff; padding: 15px; border-radius: 8px; text-align: center;">
                            <h3 style="margin: 0; color: #0078D4;">${data.tokens.length}</h3>
                            <p style="margin: 5px 0 0 0; color: #666;">Total Azure Tokens</p>
                        </div>
                        <div style="background-color: #d4edda; padding: 15px; border-radius: 8px; text-align: center;">
                            <h3 style="margin: 0; color: #155724;">${activeTokens}</h3>
                            <p style="margin: 5px 0 0 0; color: #666;">Active Tokens</p>
                        </div>
                        <div style="background-color: #f8d7da; padding: 15px; border-radius: 8px; text-align: center;">
                            <h3 style="margin: 0; color: #721c24;">${expiredTokens}</h3>
                            <p style="margin: 5px 0 0 0; color: #666;">Expired Tokens</p>
                        </div>
                    </div>
                    
                    <div style="background-color: #e7f3ff; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                        <p style="margin: 0;"><strong>Note:</strong> These are Azure AD tokens received from Microsoft during the authentication process. They are stored for administrative tracking and debugging purposes.</p>
                    </div>
                `;
                
                // Create table for tokens
                html += `
                    <div style="overflow-x: auto;">
                        <table style="width: 100%; border-collapse: collapse; background-color: white; box-shadow: 0 2px 4px rgba(0,0,0,0.1); border-radius: 8px; overflow: hidden;">
                            <thead>
                                <tr style="background-color: #f8f9fa; border-bottom: 2px solid #dee2e6;">
                                    <th style="padding: 12px; text-align: left; font-weight: 600;">#</th>
                                    <th style="padding: 12px; text-align: left; font-weight: 600;">User</th>
                                    <th style="padding: 12px; text-align: left; font-weight: 600;">Email</th>
                                    <th style="padding: 12px; text-align: left; font-weight: 600;">Issued</th>
                                    <th style="padding: 12px; text-align: left; font-weight: 600;">Expires</th>
                                    <th style="padding: 12px; text-align: left; font-weight: 600;">Status</th>
                                    <th style="padding: 12px; text-align: left; font-weight: 600;">Issuer</th>
                                    <th style="padding: 12px; text-align: center; font-weight: 600;">Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                `;
                
                data.tokens.forEach((tokenInfo, index) => {
                    const issuedDate = new Date(tokenInfo.issued_at);
                    const expiryDate = new Date(tokenInfo.expires_at);
                    const now = new Date();
                    const isExpired = expiryDate <= now;
                    
                    // Calculate time difference in milliseconds
                    const timeUntilExpiry = expiryDate.getTime() - now.getTime();
                    const timeDuration = formatTimeDuration(timeUntilExpiry);
                    
                    let statusBadge;
                    if (isExpired) {
                        statusBadge = `<span class="status" style="background-color: #fff2e8; color: var(--warning-color); border: 1px solid #ffbb96;">Expired ${timeDuration} ago</span>`;
                    } else {
                        statusBadge = `<span class="status authenticated">Active (${timeDuration} left)</span>`;
                    }
                    
                    const rowStyle = index % 2 === 0 ? 'background-color: #ffffff;' : 'background-color: #f8f9fa;';
                    
                    // Truncate issuer for display
                    const issuerShort = tokenInfo.issuer.length > 50 ? tokenInfo.issuer.substring(0, 50) + '...' : tokenInfo.issuer;
                    
                    html += `
                        <tr style="${rowStyle} border-bottom: 1px solid #dee2e6;">
                            <td style="padding: 12px;">${index + 1}</td>
                            <td style="padding: 12px; font-weight: 500;">${tokenInfo.user?.name || 'N/A'}</td>
                            <td style="padding: 12px; font-size: 14px; color: #666;">${tokenInfo.user?.email || 'N/A'}</td>
                            <td style="padding: 12px; font-size: 14px;" title="${formatDateUTC(tokenInfo.issued_at)}">${formatDateEST(tokenInfo.issued_at)}</td>
                            <td style="padding: 12px; font-size: 14px;" title="${formatDateUTC(tokenInfo.expires_at)}">${formatDateEST(tokenInfo.expires_at)}</td>
                            <td style="padding: 12px;">${statusBadge}</td>
                            <td style="padding: 12px; font-size: 12px; color: #666;" title="${tokenInfo.issuer}">${issuerShort}</td>
                            <td style="padding: 12px; text-align: center;">
                                <button onclick="showAzureTokenDetails(${index})" style="background-color: #0078D4; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 12px; margin-right: 5px;">View Details</button>
                                <button onclick="showAzureTokenActivityLog('${tokenInfo.id}')" style="background-color: #28a745; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 12px; margin-right: 5px;">View Log</button>
                                <button onclick="removeAzureToken('${tokenInfo.id}')" style="background-color: #dc3545; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 12px;">Remove</button>
                            </td>
                        </tr>
                    `;
                });
                
                html += `
                            </tbody>
                        </table>
                    </div>
                `;
                
                // Add hidden divs to store token details
                html += '<div id="azure-token-details-storage" style="display: none;">';
                data.tokens.forEach((tokenInfo, index) => {
                    html += `<div id="azure-token-detail-${index}">${JSON.stringify(tokenInfo, null, 2)}</div>`;
                });
                html += '</div>';
                
            } else {
                html += '<p>No Azure tokens found or you do not have permission to view this information.</p>';
            }
            
            html += `
                    </div>
                </div>
            `;
            
            azureTokenListContainer.innerHTML = html;
            mainContent.appendChild(azureTokenListContainer);
            
            // Scroll to the new container
            azureTokenListContainer.scrollIntoView({behavior: 'smooth', block: 'start'});
        }
        
        function showAzureTokenDetails(index) {
            const tokenDetail = document.getElementById(`azure-token-detail-${index}`);
            if (tokenDetail) {
                const tokenData = JSON.parse(tokenDetail.textContent);
                
                // Create modal overlay
                const modal = document.createElement('div');
                modal.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background-color: rgba(0, 0, 0, 0.5);
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    z-index: 2000;
                `;
                
                // Create modal content
                const modalContent = document.createElement('div');
                modalContent.style.cssText = `
                    background-color: white;
                    padding: 30px;
                    border-radius: 8px;
                    max-width: 900px;
                    width: 90%;
                    max-height: 80vh;
                    overflow-y: auto;
                    position: relative;
                    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
                `;
                
                // Format token display
                let tokenDisplay = `
                    <h3 style="margin-top: 0; margin-bottom: 20px; color: #0078D4;">Azure AD Token Details</h3>
                    
                    <div style="background-color: #e7f3ff; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                        <h4 style="margin-top: 0; margin-bottom: 10px;">Token Information</h4>
                        <p style="margin: 5px 0;"><strong>User:</strong> ${tokenData.user.name} (${tokenData.user.email})</p>
                        <p style="margin: 5px 0;"><strong>Subject:</strong> ${tokenData.subject}</p>
                        <p style="margin: 5px 0;"><strong>Issuer:</strong> ${tokenData.issuer}</p>
                        <p style="margin: 5px 0;"><strong>Audience:</strong> ${tokenData.audience}</p>
                        <p style="margin: 5px 0;"><strong>Issued:</strong> ${new Date(tokenData.issued_at).toLocaleString()}</p>
                        <p style="margin: 5px 0;"><strong>Expires:</strong> ${new Date(tokenData.expires_at).toLocaleString()}</p>
                    </div>
                    
                    <div style="margin-bottom: 20px;">
                        <h4 style="margin-bottom: 10px;">ID Token</h4>
                        <div style="background-color: #f5f5f5; padding: 15px; border-radius: 4px; overflow-x: auto; word-break: break-all; font-family: monospace; font-size: 12px;">
                            ${tokenData.full_id_token}
                        </div>
                    </div>
                    
                    <div style="margin-bottom: 20px;">
                        <h4 style="margin-bottom: 10px;">Access Token</h4>
                        <div style="background-color: #f5f5f5; padding: 15px; border-radius: 4px; overflow-x: auto; word-break: break-all; font-family: monospace; font-size: 12px;">
                            ${tokenData.full_access_token}
                        </div>
                    </div>
                    
                    <div style="margin-bottom: 20px;">
                        <h4 style="margin-bottom: 10px;">Token Claims</h4>
                        <pre style="background-color: #f5f5f5; padding: 15px; border-radius: 4px; overflow-x: auto; font-size: 12px;">${JSON.stringify(tokenData.claims, null, 2)}</pre>
                    </div>
                `;
                
                modalContent.innerHTML = `
                    <button onclick="this.closest('div').parentElement.remove()" style="position: absolute; top: 10px; right: 10px; background: none; border: none; font-size: 24px; cursor: pointer;">&times;</button>
                    ${tokenDisplay}
                `;
                
                modal.appendChild(modalContent);
                document.body.appendChild(modal);
                
                // Close modal when clicking outside
                modal.addEventListener('click', function(e) {
                    if (e.target === modal) {
                        modal.remove();
                    }
                });
            }
        }
        
        async function removeAzureToken(tokenId) {
            // Show confirmation dialog
            if (!confirm(`Are you sure you want to remove this Azure token from storage?\n\nToken ID: ${tokenId}\n\nNote: This only removes it from our storage. The token remains valid in Azure AD.`)) {
                return;
            }
            
            try {
                // Get the access token from localStorage (stored by viewAllAzureTokens function)
                const accessToken = localStorage.getItem('access_token');
                
                if (!accessToken) {
                    // If not in localStorage, try to get it from session
                    const tokenResponse = await fetch('/auth/token/session', {
                        method: 'POST',
                        credentials: 'include'
                    });
                    
                    if (!tokenResponse.ok) {
                        showResponse('Error', {error: 'Not authenticated. Please login first.'});
                        return;
                    }
                    
                    const tokenData = await tokenResponse.json();
                    localStorage.setItem('access_token', tokenData.access_token);
                }
                
                // Call the remove endpoint
                const response = await fetch(`/auth/admin/azure-tokens/${tokenId}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('access_token')}`
                    },
                    credentials: 'include'
                });
                
                if (response.ok) {
                    const result = await response.json();
                    // Show success message
                    showResponse('Success', result);
                    
                    // Refresh the token list after a short delay
                    setTimeout(() => {
                        viewAllAzureTokens();
                    }, 1500);
                } else {
                    const errorData = await response.json();
                    showResponse('Error', {
                        status: response.status,
                        statusText: response.statusText,
                        detail: errorData.detail || 'Failed to remove Azure token'
                    });
                }
            } catch (error) {
                showResponse('Error', {error: error.message});
            }
        }
        
        // Tab switching functions
        function showTokenManagement() {
            // Update URL
            updateURL('/admin/tokens');
            
            // Update tab styles
            document.getElementById('tokenTab').style.background = '#0078D4';
            document.getElementById('tokenTab').style.color = 'white';
            document.getElementById('appTab').style.background = '#f0f0f0';
            document.getElementById('appTab').style.color = '#333';
            
            // Show token management content
            if (window.adminTokenData) {
                const { internalData, azureData } = window.adminTokenData;
                showUnifiedTokenView(internalData, azureData);
            }
        }
        
        function showAppManagement() {
            // Update URL
            updateURL('/admin/apps');
            
            // Update tab styles
            document.getElementById('appTab').style.background = '#0078D4';
            document.getElementById('appTab').style.color = 'white';
            document.getElementById('tokenTab').style.background = '#f0f0f0';
            document.getElementById('tokenTab').style.color = '#333';
            
            // Show app management content
            loadAppManagement();
        }
        
        async function loadAppManagement() {
            const adminContent = document.getElementById('adminContent');
            adminContent.innerHTML = '<div style="text-align: center; padding: 40px;"><div class="spinner"></div><p>Loading app management...</p></div>';
            
            try {
                const accessToken = localStorage.getItem('access_token');
                const response = await fetch('/auth/admin/apps', {
                    headers: {
                        'Authorization': `Bearer ${accessToken}`
                    }
                });
                
                if (response.ok) {
                    const apps = await response.json();
                    displayAppManagement(apps);
                } else {
                    adminContent.innerHTML = '<div style="color: red; padding: 20px;">Failed to load apps. Please check your permissions.</div>';
                }
            } catch (error) {
                adminContent.innerHTML = '<div style="color: red; padding: 20px;">Error: ' + error.message + '</div>';
            }
        }
        
        function showAppMessage(type, message) {
            const adminContent = document.getElementById('adminContent');
            const existingMsg = document.getElementById('app-message');
            if (existingMsg) {
                existingMsg.remove();
            }
            
            const msgDiv = document.createElement('div');
            msgDiv.id = 'app-message';
            
            // Set styling based on message type
            let bgColor, textColor;
            if (type === 'success') {
                bgColor = '#d4edda';
                textColor = '#155724';
            } else if (type === 'info') {
                bgColor = '#d1ecf1';
                textColor = '#0c5460';
            } else if (type === 'warning') {
                bgColor = '#fff3cd';
                textColor = '#856404';
            } else {
                bgColor = '#f8d7da';
                textColor = '#721c24';
            }
            
            msgDiv.style.cssText = `
                padding: 15px;
                margin: 15px 0;
                border-radius: 4px;
                background: ${bgColor};
                color: ${textColor};
            `;
            
            if (typeof message === 'string') {
                msgDiv.textContent = message;
            } else {
                msgDiv.innerHTML = message;
            }
            
            adminContent.insertBefore(msgDiv, adminContent.firstChild);
            
            // Auto-hide after 10 seconds
            setTimeout(() => {
                if (msgDiv.parentNode) {
                    msgDiv.remove();
                }
            }, 10000);
        }
        
        function displayAppManagement(apps) {
            const adminContent = document.getElementById('adminContent');
            
            let html = `
                <h3 style="color: #333; margin-bottom: 20px;">App Registration Management</h3>
                
                <!-- Register New App Form -->
                <div style="background-color: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                    <h4 style="margin-top: 0;">Register New App</h4>
                    <form id="register-app-form" onsubmit="registerApp(event)">
                        <div style="display: grid; gap: 15px;">
                            <div>
                                <label style="display: block; margin-bottom: 5px; font-weight: 500;">App Name</label>
                                <input type="text" name="name" required style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 5px; font-weight: 500;">Description</label>
                                <textarea name="description" required style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; min-height: 60px;"></textarea>
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 5px; font-weight: 500;">Owner Email</label>
                                <input type="email" name="owner_email" required style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 5px; font-weight: 500;">Redirect URIs (one per line)</label>
                                <textarea name="redirect_uris" required placeholder="https://myapp.company.com/auth/callback" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; min-height: 80px;"></textarea>
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 5px; font-weight: 500;">Discovery Endpoint (Optional)</label>
                                <input type="url" name="discovery_endpoint" placeholder="https://myapp.company.com/discovery/endpoints" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                                <small style="color: #666; display: block; margin-top: 3px;">URL where your app exposes its API endpoints for discovery</small>
                            </div>
                            <div>
                                <label style="display: flex; align-items: center; gap: 5px; margin-bottom: 5px;">
                                    <input type="checkbox" name="allow_discovery">
                                    <span style="font-weight: 500;">Allow Endpoint Discovery</span>
                                </label>
                                <small style="color: #666; display: block; margin-left: 25px;">Enable CIDS to automatically discover and pull endpoints from your app</small>
                            </div>
                            <button type="submit" style="padding: 10px 20px; background-color: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer; margin-top: 10px;">Register App</button>
                        </div>
                    </form>
                </div>
                
                <!-- Registered Apps List -->
                <h4>Registered Apps</h4>
                <div style="display: grid; gap: 15px;">
            `;
            
            if (apps.length === 0) {
                html += '<p style="color: #666;">No apps registered yet.</p>';
            } else {
                apps.forEach(app => {
                    const statusColor = app.is_active ? '#28a745' : '#dc3545';
                    const statusText = app.is_active ? 'Active' : 'Inactive';
                    
                    html += `
                        <div style="background-color: white; border: 1px solid #ddd; padding: 20px; border-radius: 8px;">
                            <div style="display: flex; justify-content: space-between; align-items: start;">
                                <div style="flex: 1;">
                                    <h5 style="margin: 0 0 10px 0; color: #333;">${app.name}</h5>
                                    <p style="margin: 5px 0; color: #666;">${app.description}</p>
                                    <p style="margin: 5px 0;"><strong>Client ID:</strong> <code style="background: #f5f5f5; padding: 2px 5px; border-radius: 3px;">${app.client_id}</code></p>
                                    <p style="margin: 5px 0;"><strong>Owner:</strong> ${app.owner_email}</p>
                                    <p style="margin: 5px 0;"><strong>Status:</strong> <span style="color: ${statusColor}; font-weight: bold;">${statusText}</span></p>
                                    <p style="margin: 5px 0;"><strong>Redirect URIs:</strong></p>
                                    <ul style="margin: 5px 0; padding-left: 20px;">
                                        ${app.redirect_uris.map(uri => `<li><code style="font-size: 12px;">${uri}</code></li>`).join('')}
                                    </ul>
                                    ${app.allow_discovery ? `
                                        <div style="margin-top: 10px; padding: 10px; background: #e8f5e9; border-radius: 4px;">
                                            <p style="margin: 5px 0;"><strong>Discovery:</strong> <span style="color: #2e7d32;">âœ“ Enabled</span></p>
                                            ${app.discovery_endpoint ? `<p style="margin: 5px 0; font-size: 14px;"><strong>Endpoint:</strong> <code style="font-size: 12px;">${app.discovery_endpoint}</code></p>` : ''}
                                            ${app.last_discovery_at ? `
                                                <p style="margin: 5px 0; font-size: 14px;">
                                                    <strong>Last Discovery:</strong> ${new Date(app.last_discovery_at).toLocaleString()}
                                                    <span style="color: ${app.discovery_status === 'success' ? '#2e7d32' : '#d32f2f'};">(${app.discovery_status || 'never run'})</span>
                                                </p>
                                            ` : '<p style="margin: 5px 0; font-size: 14px; color: #666;">Never discovered</p>'}
                                        </div>
                                    ` : ''}
                                </div>
                                <div style="display: flex; flex-direction: column; gap: 10px;">
                                    <button onclick="viewRoleMappings('${app.client_id}')" style="padding: 6px 12px; background-color: #17a2b8; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 14px;">Role Mappings</button>
                                    ${app.allow_discovery ? `
                                        <button onclick="viewEndpoints('${app.client_id}')" style="padding: 6px 12px; background-color: #6c757d; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 14px;">View Endpoints</button>
                                        <button onclick="viewPermissions('${app.client_id}')" style="padding: 6px 12px; background-color: #9c27b0; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 14px;">View Permissions</button>
                                        <button onclick="manageRoles('${app.client_id}')" style="padding: 6px 12px; background-color: #ff5722; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 14px;">Permission Roles</button>
                                        <button onclick="triggerDiscovery('${app.client_id}')" style="padding: 6px 12px; background-color: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 14px;">Run Discovery</button>
                                    ` : ''}
                                    <button onclick="rotateAppSecret('${app.client_id}')" style="padding: 6px 12px; background-color: #ffc107; color: #333; border: none; border-radius: 4px; cursor: pointer; font-size: 14px;">Rotate Secret</button>
                                    <button onclick="deleteApp('${app.client_id}')" style="padding: 6px 12px; background-color: #dc3545; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 14px;">Delete</button>
                                </div>
                            </div>
                        </div>
                    `;
                });
            }
            
            html += '</div>';
            adminContent.innerHTML = html;
        }
        
        async function registerApp(event) {
            event.preventDefault();
            const form = event.target;
            const formData = new FormData(form);
            
            const data = {
                name: formData.get('name'),
                description: formData.get('description'),
                owner_email: formData.get('owner_email'),
                redirect_uris: formData.get('redirect_uris').split('\n').map(uri => uri.trim()).filter(uri => uri),
                discovery_endpoint: formData.get('discovery_endpoint') || null,
                allow_discovery: formData.get('allow_discovery') === 'on'
            };
            
            try {
                const accessToken = localStorage.getItem('access_token');
                const response = await fetch('/auth/admin/apps', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${accessToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                });
                
                if (response.ok) {
                    const result = await response.json();
                    
                    // Show success with credentials
                    const message = `
                        <div style="background: #d4edda; padding: 20px; border-radius: 8px; margin: 20px 0;">
                            <h4 style="color: #155724; margin-top: 0;">App Registered Successfully!</h4>
                            <p style="color: #155724;"><strong>Important:</strong> Save these credentials now. The client secret will not be shown again.</p>
                            <p><strong>Client ID:</strong> <code style="background: #fff; padding: 2px 5px;">${result.app.client_id}</code></p>
                            <p><strong>Client Secret:</strong> <code style="background: #fff; padding: 2px 5px;">${result.client_secret}</code></p>
                        </div>
                    `;
                    
                    // Show success message inline
                    showAppMessage('success', message);
                    form.reset();
                    loadAppManagement(); // Reload the list
                } else {
                    const error = await response.json();
                    showAppMessage('error', error.detail || 'Failed to register app');
                }
            } catch (error) {
                showAppMessage('error', error.message);
            }
        }
        
        async function viewRoleMappings(clientId) {
            try {
                const accessToken = localStorage.getItem('access_token');
                
                // Show loading
                const adminContent = document.getElementById('adminContent');
                adminContent.innerHTML = '<div style="text-align: center; padding: 40px;"><div class="spinner"></div><p>Loading role mappings...</p></div>';
                
                // Fetch app details, endpoints, and current mappings in parallel
                const [appResponse, endpointsResponse, mappingsResponse, userGroupsResponse] = await Promise.all([
                    fetch(`/auth/admin/apps/${clientId}`, {
                        headers: { 'Authorization': `Bearer ${accessToken}` }
                    }),
                    fetch(`/auth/admin/apps/${clientId}/endpoints`, {
                        headers: { 'Authorization': `Bearer ${accessToken}` }
                    }),
                    fetch(`/auth/admin/apps/${clientId}/role-mappings`, {
                        headers: { 'Authorization': `Bearer ${accessToken}` }
                    }),
                    fetch('/auth/user/groups', {
                        headers: { 'Authorization': `Bearer ${accessToken}` }
                    })
                ]);
                
                if (!appResponse.ok) {
                    showAppMessage('error', 'Failed to load app details');
                    loadAppManagement();
                    return;
                }
                
                const appData = await appResponse.json();
                const endpoints = endpointsResponse.ok ? await endpointsResponse.json() : { endpoints: [] };
                const mappingsData = mappingsResponse.ok ? await mappingsResponse.json() : { mappings: [] };
                const userGroups = userGroupsResponse.ok ? await userGroupsResponse.json() : { groups: [] };
                
                // Create the role mapping interface
                // The app endpoint returns the app directly, not wrapped in an object
                showRoleMappingInterface(clientId, appData, endpoints.endpoints || endpoints, mappingsData.mappings, userGroups.groups);
                
            } catch (error) {
                showAppMessage('error', `Error loading role mappings: ${error.message}`);
                loadAppManagement();
            }
        }
        
        function showRoleMappingInterface(clientId, app, endpoints, existingMappings, availableGroups) {
            const adminContent = document.getElementById('adminContent');
            
            // Get unique roles from endpoints
            const endpointRoles = new Set();
            endpoints.forEach(ep => {
                if (ep.required_roles) {
                    ep.required_roles.forEach(role => endpointRoles.add(role));
                }
            });
            
            // Get all roles (from endpoints and existing mappings)
            const allRoles = new Set([...endpointRoles]);
            existingMappings.forEach(m => allRoles.add(m.app_role));
            
            let html = `
                <div style="margin-bottom: 20px;">
                    <button onclick="loadAppManagement()" class="secondary-button">â† Back to Apps</button>
                </div>
                
                <h2>Role Mappings for ${app.name}</h2>
                <p style="color: #666; margin-bottom: 30px;">Configure how Azure AD groups map to application roles</p>
                
                ${app.allow_discovery ? `
                    <div style="background: #e3f2fd; padding: 15px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #2196f3;">
                        <strong>Field-Level Permissions:</strong> This app supports field-level permissions. 
                        After creating role mappings here, use the "Permission Roles" button to define what fields each role can access.
                    </div>
                ` : ''}
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px;">
                    <!-- Left column: App Roles -->
                    <div style="background: #f5f5f5; padding: 20px; border-radius: 8px;">
                        <h3>Application Roles</h3>
                        <p style="font-size: 14px; color: #666; margin-bottom: 20px;">Define roles for your application and assign endpoints to them</p>
                        
                        <!-- Add new role -->
                        <div style="background: white; padding: 15px; border-radius: 6px; margin-bottom: 20px;">
                            <h4 style="margin-top: 0;">Create New Role</h4>
                            <div style="display: flex; gap: 10px;">
                                <input type="text" id="newRoleName" placeholder="Role name (e.g., editor, viewer)" 
                                    style="flex: 1; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                                <button onclick="addAppRole('${clientId}')" 
                                    style="padding: 8px 16px; background: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer;">
                                    Add Role
                                </button>
                            </div>
                        </div>
                        
                        <!-- Existing roles -->
                        <div id="appRolesList">
                            ${Array.from(allRoles).map(role => `
                                <div style="background: white; padding: 15px; border-radius: 6px; margin-bottom: 10px;">
                                    <h4 style="margin: 0 0 10px 0; color: #333;">${role}</h4>
                                    <p style="font-size: 14px; color: #666; margin: 0 0 10px 0;">Endpoints using this role:</p>
                                    <ul style="margin: 0; padding-left: 20px; font-size: 14px;">
                                        ${endpoints.filter(ep => ep.required_roles && ep.required_roles.includes(role))
                                            .map(ep => `<li>${ep.method} ${ep.path}</li>`).join('') || '<li style="color: #999;">No endpoints assigned</li>'}
                                    </ul>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                    
                    <!-- Right column: Group Mappings -->
                    <div style="background: #f5f5f5; padding: 20px; border-radius: 8px;">
                        <h3>Azure AD Group Mappings</h3>
                        <p style="font-size: 14px; color: #666; margin-bottom: 20px;">Map Azure AD groups to application roles</p>
                        
                        <!-- Add new mapping -->
                        <div style="background: white; padding: 15px; border-radius: 6px; margin-bottom: 20px;">
                            <h4 style="margin-top: 0;">Add Group Mapping</h4>
                            <div style="margin-bottom: 10px;">
                                <label style="display: block; margin-bottom: 5px; font-size: 14px;">Azure AD Group:</label>
                                <select id="adGroupSelect" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                                    <option value="">Select a group...</option>
                                    ${availableGroups.map(group => 
                                        `<option value="${group.id || group}">${group.displayName || group}</option>`
                                    ).join('')}
                                </select>
                            </div>
                            <div style="margin-bottom: 10px;">
                                <label style="display: block; margin-bottom: 5px; font-size: 14px;">Application Role:</label>
                                <select id="appRoleSelect" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                                    <option value="">Select a role...</option>
                                    ${Array.from(allRoles).map(role => 
                                        `<option value="${role}">${role}</option>`
                                    ).join('')}
                                </select>
                            </div>
                            <button onclick="addRoleMapping('${clientId}')" 
                                style="width: 100%; padding: 10px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer;">
                                Add Mapping
                            </button>
                        </div>
                        
                        <!-- Existing mappings -->
                        <div id="groupMappingsList">
                            <h4 style="margin: 20px 0 10px 0;">Current Mappings</h4>
                            ${existingMappings.length === 0 ? 
                                '<p style="color: #999; font-size: 14px;">No mappings configured yet</p>' :
                                existingMappings.map((mapping, idx) => `
                                    <div style="background: white; padding: 10px 15px; border-radius: 6px; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center;">
                                        <div>
                                            <strong>${mapping.ad_group}</strong>
                                            <span style="color: #666; margin: 0 10px;">â†’</span>
                                            <span style="color: #007bff;">${mapping.app_role}</span>
                                        </div>
                                        <button onclick="removeRoleMapping('${clientId}', '${mapping.ad_group}', '${mapping.app_role}')" 
                                            style="padding: 5px 10px; background: #dc3545; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;">
                                            Remove
                                        </button>
                                    </div>
                                `).join('')
                            }
                        </div>
                    </div>
                </div>
                
                <!-- Endpoints overview -->
                <div style="margin-top: 30px; background: #f5f5f5; padding: 20px; border-radius: 8px;">
                    <h3>Discovered Endpoints</h3>
                    <p style="font-size: 14px; color: #666; margin-bottom: 20px;">All endpoints discovered from the application</p>
                    <div style="max-height: 300px; overflow-y: auto;">
                        <table style="width: 100%; background: white; border-radius: 6px; overflow: hidden;">
                            <thead>
                                <tr style="background: #e9ecef;">
                                    <th style="padding: 10px; text-align: left;">Method</th>
                                    <th style="padding: 10px; text-align: left;">Path</th>
                                    <th style="padding: 10px; text-align: left;">Description</th>
                                    <th style="padding: 10px; text-align: left;">Required Roles</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${endpoints.map(ep => `
                                    <tr style="border-top: 1px solid #dee2e6;">
                                        <td style="padding: 10px; font-weight: bold; color: ${getMethodColor(ep.method)};">${ep.method}</td>
                                        <td style="padding: 10px; font-family: monospace; font-size: 13px;">${ep.path}</td>
                                        <td style="padding: 10px; font-size: 14px;">${ep.description || '-'}</td>
                                        <td style="padding: 10px; font-size: 14px;">
                                            ${ep.required_roles && ep.required_roles.length > 0 ? 
                                                ep.required_roles.map(r => `<span style="background: #e7f3ff; color: #0066cc; padding: 2px 8px; border-radius: 3px; font-size: 12px;">${r}</span>`).join(' ') : 
                                                '<span style="color: #999;">Public</span>'
                                            }
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
            
            adminContent.innerHTML = html;
        }
        
        function getMethodColor(method) {
            const colors = {
                'GET': '#28a745',
                'POST': '#007bff',
                'PUT': '#ffc107',
                'DELETE': '#dc3545',
                'PATCH': '#17a2b8'
            };
            return colors[method] || '#6c757d';
        }
        
        async function addAppRole(clientId) {
            const roleName = document.getElementById('newRoleName').value.trim();
            if (!roleName) {
                showAppMessage('error', 'Please enter a role name');
                return;
            }
            
            // For now, just refresh the interface - in a real implementation,
            // you might want to store custom roles separately
            showAppMessage('info', `Role "${roleName}" created. You can now map it to AD groups.`);
            document.getElementById('newRoleName').value = '';
            
            // Refresh the interface
            viewRoleMappings(clientId);
        }
        
        async function addRoleMapping(clientId) {
            const adGroup = document.getElementById('adGroupSelect').value;
            const appRole = document.getElementById('appRoleSelect').value;
            
            if (!adGroup || !appRole) {
                showAppMessage('error', 'Please select both an AD group and an application role');
                return;
            }
            
            try {
                const accessToken = localStorage.getItem('access_token');
                
                // Get current mappings
                const response = await fetch(`/auth/admin/apps/${clientId}/role-mappings`, {
                    headers: { 'Authorization': `Bearer ${accessToken}` }
                });
                
                const data = await response.json();
                const currentMappings = data.mappings || [];
                
                // Check if mapping already exists
                if (currentMappings.some(m => m.ad_group === adGroup && m.app_role === appRole)) {
                    showAppMessage('warning', 'This mapping already exists');
                    return;
                }
                
                // Create new mappings object
                const mappings = {};
                currentMappings.forEach(m => {
                    if (!mappings[m.ad_group]) mappings[m.ad_group] = [];
                    mappings[m.ad_group].push(m.app_role);
                });
                
                if (!mappings[adGroup]) mappings[adGroup] = [];
                mappings[adGroup].push(appRole);
                
                // Update mappings
                const updateResponse = await fetch(`/auth/admin/apps/${clientId}/role-mappings`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${accessToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ mappings })
                });
                
                if (updateResponse.ok) {
                    showAppMessage('success', 'Role mapping added successfully');
                    viewRoleMappings(clientId);
                } else {
                    showAppMessage('error', 'Failed to add role mapping');
                }
            } catch (error) {
                showAppMessage('error', `Error adding role mapping: ${error.message}`);
            }
        }
        
        async function removeRoleMapping(clientId, adGroup, appRole) {
            if (!confirm(`Remove mapping: ${adGroup} â†’ ${appRole}?`)) {
                return;
            }
            
            try {
                const accessToken = localStorage.getItem('access_token');
                
                // Get current mappings
                const response = await fetch(`/auth/admin/apps/${clientId}/role-mappings`, {
                    headers: { 'Authorization': `Bearer ${accessToken}` }
                });
                
                const data = await response.json();
                const currentMappings = data.mappings || [];
                
                // Create new mappings object without the removed mapping
                const mappings = {};
                currentMappings.forEach(m => {
                    if (!(m.ad_group === adGroup && m.app_role === appRole)) {
                        if (!mappings[m.ad_group]) mappings[m.ad_group] = [];
                        mappings[m.ad_group].push(m.app_role);
                    }
                });
                
                // Update mappings
                const updateResponse = await fetch(`/auth/admin/apps/${clientId}/role-mappings`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${accessToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ mappings })
                });
                
                if (updateResponse.ok) {
                    showAppMessage('success', 'Role mapping removed successfully');
                    viewRoleMappings(clientId);
                } else {
                    showAppMessage('error', 'Failed to remove role mapping');
                }
            } catch (error) {
                showAppMessage('error', `Error removing role mapping: ${error.message}`);
            }
        }
        
        async function rotateAppSecret(clientId) {
            if (!confirm('Are you sure you want to rotate the client secret? The old secret will stop working immediately.')) {
                return;
            }
            
            try {
                const accessToken = localStorage.getItem('access_token');
                const response = await fetch(`/auth/admin/apps/${clientId}/rotate-secret`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${accessToken}`
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    const message = `
                        <div style="background: #fff3cd; padding: 20px; border-radius: 8px;">
                            <h4 style="color: #856404; margin-top: 0;">Client Secret Rotated</h4>
                            <p style="color: #856404;"><strong>Important:</strong> Save this new secret now. It will not be shown again.</p>
                            <p><strong>Client ID:</strong> <code style="background: #fff; padding: 2px 5px;">${data.client_id}</code></p>
                            <p><strong>New Client Secret:</strong> <code style="background: #fff; padding: 2px 5px;">${data.client_secret}</code></p>
                        </div>
                    `;
                    showAppMessage('success', message);
                } else {
                    showAppMessage('error', 'Failed to rotate secret');
                }
            } catch (error) {
                showAppMessage('error', error.message);
            }
        }
        
        async function viewEndpoints(clientId) {
            try {
                const accessToken = localStorage.getItem('access_token');
                const response = await fetch(`/apps/${clientId}/endpoints`, {
                    headers: {
                        'Authorization': `Bearer ${accessToken}`
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    
                    if (!data || !data.endpoints || data.endpoints.length === 0) {
                        alert('No endpoints registered for this app.');
                    } else {
                        const endpointList = data.endpoints.map(e => 
                            `â€¢ ${e.method} ${e.path} - ${e.description}${e.discovered ? ' (discovered)' : ''}`
                        ).join('\n');
                        
                        const message = `Endpoints for ${clientId}:\n\n${endpointList}\n\nTotal: ${data.endpoints.length} endpoints`;
                        alert(message);
                    }
                } else {
                    alert('Failed to load endpoints');
                }
            } catch (error) {
                alert('Error loading endpoints: ' + error.message);
            }
        }
        
        async function triggerDiscovery(clientId) {
            try {
                const accessToken = localStorage.getItem('access_token');
                const adminContent = document.getElementById('adminContent');
                
                // Show loading message
                const originalContent = adminContent.innerHTML;
                const loadingOverlay = document.createElement('div');
                loadingOverlay.style = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 9999;';
                loadingOverlay.innerHTML = '<div style="background: white; padding: 20px; border-radius: 8px;"><div class="spinner"></div><p>Running discovery...</p></div>';
                document.body.appendChild(loadingOverlay);
                
                // Try v2 discovery first, fallback to v1
                console.log(`Triggering discovery for client: ${clientId}`);
                let response = await fetch(`/discovery/v2/endpoints/${clientId}`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${accessToken}`
                    }
                });
                
                console.log(`V2 discovery response status: ${response.status}`);
                
                // If v2 fails, try v1
                if (!response.ok && response.status === 404) {
                    console.log('V2 not found, trying V1 discovery...');
                    response = await fetch(`/discovery/endpoints/${clientId}`, {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${accessToken}`
                        }
                    });
                    console.log(`V1 discovery response status: ${response.status}`);
                }
                
                document.body.removeChild(loadingOverlay);
                
                if (response.ok) {
                    const result = await response.json();
                    console.log('Discovery result:', result); // Debug log
                    
                    if (result.status === 'success') {
                        let message = `Discovery completed! `;
                        if (result.permissions_generated) {
                            message += `Generated ${result.permissions_generated} permissions (${result.sensitive_permissions} sensitive).`;
                        } else if (result.endpoints_discovered !== undefined) {
                            message += `Found ${result.endpoints_discovered} endpoints.`;
                        }
                        console.log('Showing success message:', message);
                        showAppMessage('success', message);
                        // Force refresh to show updated discovery status
                        setTimeout(() => {
                            console.log('Refreshing app list...');
                            loadAppManagement();
                        }, 500); // Give time for backend to update
                    } else if (result.status === 'cached') {
                        showAppMessage('info', `${result.message} (${result.permissions_count} permissions)`);
                        loadAppManagement();
                    } else if (result.status === 'skipped') {
                        showAppMessage('info', result.message);
                    } else if (result.status === 'error') {
                        showAppMessage('error', result.error || 'Discovery failed');
                    } else {
                        // Unexpected response format
                        showAppMessage('warning', 'Discovery completed but response format was unexpected');
                        console.log('Unexpected discovery response:', result);
                        loadAppManagement();
                    }
                } else {
                    try {
                        const error = await response.json();
                        showAppMessage('error', error.detail || error.error || 'Discovery failed');
                    } catch (e) {
                        showAppMessage('error', 'Discovery failed: Unable to parse response');
                    }
                }
            } catch (error) {
                // Make sure to remove overlay on error
                if (document.body.contains(loadingOverlay)) {
                    document.body.removeChild(loadingOverlay);
                }
                console.error('Discovery error:', error);
                const errorMsg = error.message || error.toString() || 'Unknown error';
                showAppMessage('error', 'Failed to trigger discovery: ' + errorMsg);
            }
        }
        
        async function deleteApp(clientId) {
            if (!confirm('Are you sure you want to delete this app? It will be deactivated and cannot be used for authentication.')) {
                return;
            }
            
            try {
                const accessToken = localStorage.getItem('access_token');
                const response = await fetch(`/auth/admin/apps/${clientId}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${accessToken}`
                    }
                });
                
                if (response.ok) {
                    showAppMessage('success', 'App has been deactivated');
                    loadAppManagement(); // Reload the list
                } else {
                    showAppMessage('error', 'Failed to delete app');
                }
            } catch (error) {
                showAppMessage('error', error.message);
            }
        }
        
        async function viewPermissions(clientId) {
            try {
                console.log(`Loading permissions for ${clientId}...`);
                const accessToken = localStorage.getItem('access_token');
                const response = await fetch(`/discovery/v2/permissions/${clientId}/tree`, {
                    headers: {
                        'Authorization': `Bearer ${accessToken}`
                    }
                });
                
                console.log(`Permissions response status: ${response.status}`);
                
                if (response.ok) {
                    const data = await response.json();
                    console.log('Permission tree data:', data);
                    showPermissionsModal(clientId, data.permission_tree || {});
                } else if (response.status === 404) {
                    showAppMessage('warning', 'No permissions discovered yet. Run discovery first.');
                } else {
                    const error = await response.text();
                    console.error('Permission load error:', error);
                    showAppMessage('error', 'Failed to load permissions');
                }
            } catch (error) {
                console.error('Error loading permissions:', error);
                showAppMessage('error', 'Error loading permissions: ' + error.message);
            }
        }
        
        async function manageRoles(clientId) {
            try {
                const accessToken = localStorage.getItem('access_token');
                
                // Fetch existing roles
                const response = await fetch(`/permissions/${clientId}/roles`, {
                    headers: {
                        'Authorization': `Bearer ${accessToken}`
                    }
                });
                
                if (!response.ok) {
                    showAppMessage('error', 'Failed to load roles');
                    return;
                }
                
                const rolesData = await response.json();
                const roles = rolesData.roles || {};
                
                // Create modal
                const modal = document.createElement('div');
                modal.className = 'modal-overlay';
                modal.onclick = (e) => {
                    if (e.target === modal) {
                        document.body.removeChild(modal);
                    }
                };
                
                const content = document.createElement('div');
                content.className = 'modal-content';
                content.style.maxWidth = '800px';
                content.style.maxHeight = '80vh';
                content.style.overflow = 'auto';
                
                // Header
                const header = document.createElement('h2');
                header.textContent = `Field-Level Permission Roles for ${clientId}`;
                header.style.marginBottom = '20px';
                content.appendChild(header);
                
                // Add explanation
                const explanation = document.createElement('p');
                explanation.style.color = '#666';
                explanation.style.marginBottom = '20px';
                explanation.textContent = 'Define roles with specific field-level permissions. These roles can then be assigned to AD groups via Role Mappings.';
                content.appendChild(explanation);
                
                // Create new role button
                const newRoleBtn = document.createElement('button');
                newRoleBtn.textContent = '+ Create New Role';
                newRoleBtn.className = 'btn btn-primary';
                newRoleBtn.style.backgroundColor = '#4CAF50';
                newRoleBtn.style.marginBottom = '20px';
                newRoleBtn.onclick = () => {
                    document.body.removeChild(modal);
                    showRoleBuilder(clientId);
                };
                content.appendChild(newRoleBtn);
                
                // Roles list
                const rolesList = document.createElement('div');
                
                if (Object.keys(roles).length === 0) {
                    rolesList.innerHTML = '<p style="color: #666;">No custom roles defined yet. Create one to get started!</p>';
                } else {
                    for (const [roleName, permissions] of Object.entries(roles)) {
                        const roleCard = document.createElement('div');
                        roleCard.style.border = '1px solid #ddd';
                        roleCard.style.borderRadius = '4px';
                        roleCard.style.padding = '15px';
                        roleCard.style.marginBottom = '10px';
                        roleCard.style.backgroundColor = '#f8f9fa';
                        
                        const roleHeader = document.createElement('div');
                        roleHeader.style.display = 'flex';
                        roleHeader.style.justifyContent = 'space-between';
                        roleHeader.style.alignItems = 'center';
                        roleHeader.style.marginBottom = '10px';
                        
                        const roleTitle = document.createElement('h4');
                        roleTitle.textContent = roleName;
                        roleTitle.style.margin = '0';
                        roleHeader.appendChild(roleTitle);
                        
                        const permCount = document.createElement('span');
                        permCount.textContent = `${permissions.length} permissions`;
                        permCount.style.fontSize = '14px';
                        permCount.style.color = '#666';
                        roleHeader.appendChild(permCount);
                        
                        roleCard.appendChild(roleHeader);
                        
                        // Permission summary
                        const permSummary = document.createElement('div');
                        permSummary.style.fontSize = '13px';
                        permSummary.style.color = '#444';
                        permSummary.style.marginBottom = '10px';
                        
                        // Group permissions by resource
                        const permsByResource = {};
                        permissions.forEach(perm => {
                            const parts = perm.split('.');
                            const resource = parts[1];
                            if (!permsByResource[resource]) {
                                permsByResource[resource] = 0;
                            }
                            permsByResource[resource]++;
                        });
                        
                        const resourceSummary = Object.entries(permsByResource)
                            .map(([res, count]) => `${res} (${count})`)
                            .join(', ');
                        
                        permSummary.textContent = `Resources: ${resourceSummary}`;
                        roleCard.appendChild(permSummary);
                        
                        // Action buttons
                        const actions = document.createElement('div');
                        actions.style.display = 'flex';
                        actions.style.gap = '10px';
                        
                        const viewBtn = document.createElement('button');
                        viewBtn.textContent = 'View Details';
                        viewBtn.className = 'btn btn-sm';
                        viewBtn.style.backgroundColor = '#17a2b8';
                        viewBtn.style.color = 'white';
                        viewBtn.onclick = () => showRoleDetails(clientId, roleName, permissions);
                        actions.appendChild(viewBtn);
                        
                        const deleteBtn = document.createElement('button');
                        deleteBtn.textContent = 'Delete';
                        deleteBtn.className = 'btn btn-sm';
                        deleteBtn.style.backgroundColor = '#dc3545';
                        deleteBtn.style.color = 'white';
                        deleteBtn.onclick = () => deleteRole(clientId, roleName);
                        actions.appendChild(deleteBtn);
                        
                        roleCard.appendChild(actions);
                        rolesList.appendChild(roleCard);
                    }
                }
                
                content.appendChild(rolesList);
                
                // Close button
                const closeBtn = document.createElement('button');
                closeBtn.textContent = 'Close';
                closeBtn.className = 'btn btn-secondary';
                closeBtn.style.marginTop = '20px';
                closeBtn.onclick = () => document.body.removeChild(modal);
                content.appendChild(closeBtn);
                
                modal.appendChild(content);
                document.body.appendChild(modal);
                
            } catch (error) {
                showAppMessage('error', 'Error loading roles: ' + error.message);
            }
        }
        
        function showRoleDetails(clientId, roleName, permissions) {
            // Create modal for role details
            const modal = document.createElement('div');
            modal.className = 'modal-overlay';
            modal.onclick = (e) => {
                if (e.target === modal) {
                    document.body.removeChild(modal);
                }
            };
            
            const content = document.createElement('div');
            content.className = 'modal-content';
            content.style.maxWidth = '700px';
            content.style.maxHeight = '80vh';
            content.style.overflow = 'auto';
            
            const header = document.createElement('h3');
            header.textContent = `Role: ${roleName}`;
            header.style.marginBottom = '15px';
            content.appendChild(header);
            
            const permList = document.createElement('div');
            permList.style.maxHeight = '400px';
            permList.style.overflowY = 'auto';
            permList.style.border = '1px solid #ddd';
            permList.style.borderRadius = '4px';
            permList.style.padding = '10px';
            
            // Sort and display permissions
            const sortedPerms = permissions.sort();
            sortedPerms.forEach(perm => {
                const permItem = document.createElement('div');
                permItem.style.padding = '5px';
                permItem.style.borderBottom = '1px solid #eee';
                permItem.innerHTML = `<code style="background: #f5f5f5; padding: 2px 5px; border-radius: 3px;">${perm}</code>`;
                permList.appendChild(permItem);
            });
            
            content.appendChild(permList);
            
            const closeBtn = document.createElement('button');
            closeBtn.textContent = 'Close';
            closeBtn.className = 'btn btn-secondary';
            closeBtn.style.marginTop = '15px';
            closeBtn.onclick = () => document.body.removeChild(modal);
            content.appendChild(closeBtn);
            
            modal.appendChild(content);
            document.body.appendChild(modal);
        }
        
        async function deleteRole(clientId, roleName) {
            if (!confirm(`Are you sure you want to delete the role "${roleName}"?`)) {
                return;
            }
            
            try {
                const accessToken = localStorage.getItem('access_token');
                const response = await fetch(`/permissions/${clientId}/roles/${roleName}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${accessToken}`
                    }
                });
                
                if (response.ok) {
                    showAppMessage('success', `Role "${roleName}" deleted successfully`);
                    manageRoles(clientId); // Refresh the roles list
                } else {
                    const error = await response.json();
                    showAppMessage('error', error.detail || 'Failed to delete role');
                }
            } catch (error) {
                showAppMessage('error', 'Error deleting role: ' + error.message);
            }
        }
        
        // Define AD Group functions globally
        window.searchAzureGroups = async function(query) {
            // Clear previous timeout
            if (window.azureGroupSearchTimeout) {
                clearTimeout(window.azureGroupSearchTimeout);
            }
            
            const resultsDiv = document.getElementById('adGroupSearchResults');
            if (!resultsDiv) return;
            
            // Hide results if query is empty
            if (!query || query.length < 2) {
                resultsDiv.style.display = 'none';
                return;
            }
            
            // Debounce search
            window.azureGroupSearchTimeout = setTimeout(async () => {
                try {
                    const accessToken = localStorage.getItem('access_token');
                    console.log('Searching Azure AD groups for:', query);
                    
                    const response = await fetch(`/auth/admin/azure-groups?search=${encodeURIComponent(query)}&top=20`, {
                        headers: {
                            'Authorization': `Bearer ${accessToken}`
                        }
                    });
                    
                    console.log('Azure groups response status:', response.status);
                    
                    if (response.ok) {
                        const data = await response.json();
                        console.log('Azure groups found:', data);
                        displayGroupSearchResults(data.groups);
                    } else {
                        const error = await response.text();
                        console.error('Failed to search groups:', response.status, error);
                        resultsDiv.innerHTML = '<div style="padding: 10px; color: #d32f2f;">Error searching groups</div>';
                        resultsDiv.style.display = 'block';
                    }
                } catch (error) {
                    console.error('Error searching groups:', error);
                    resultsDiv.innerHTML = '<div style="padding: 10px; color: #d32f2f;">Network error</div>';
                    resultsDiv.style.display = 'block';
                }
            }, 300); // Wait 300ms after user stops typing
        };
        
        window.displayGroupSearchResults = function(groups) {
            const resultsDiv = document.getElementById('adGroupSearchResults');
            if (!resultsDiv) return;
            
            if (groups.length === 0) {
                resultsDiv.innerHTML = '<div style="padding: 10px; color: #666;">No groups found</div>';
            } else {
                resultsDiv.innerHTML = groups.map(group => {
                    const escapedDisplayName = group.displayName.replace(/'/g, "\\'").replace(/"/g, "&quot;");
                    const escapedId = group.id.replace(/'/g, "\\'");
                    return `
                        <div onclick="selectAzureGroup('${escapedDisplayName}', '${escapedId}')" 
                             style="padding: 8px; cursor: pointer; border-bottom: 1px solid #eee;"
                             onmouseover="this.style.backgroundColor='#f5f5f5'" 
                             onmouseout="this.style.backgroundColor='white'">
                            <strong>${group.displayName}</strong>
                            ${group.description ? `<br><small style="color: #666;">${group.description}</small>` : ''}
                        </div>
                    `;
                }).join('');
            }
            
            resultsDiv.style.display = 'block';
        };
        
        window.selectAzureGroup = function(displayName, groupId) {
            if (!window.adGroupMappings) window.adGroupMappings = {};
            
            if (window.adGroupMappings[displayName]) {
                showAppMessage('warning', 'This group is already added');
                return;
            }
            
            window.adGroupMappings[displayName] = groupId;
            updateAdGroupsList();
            
            // Clear search
            document.getElementById('adGroupSearch').value = '';
            document.getElementById('adGroupSearchResults').style.display = 'none';
        };
        
        window.removeAdGroupMapping = function(displayName) {
            if (window.adGroupMappings) {
                delete window.adGroupMappings[displayName];
                updateAdGroupsList();
            }
        };
        
        window.updateAdGroupsList = function() {
            const list = document.getElementById('adGroupsList');
            if (!list || !window.adGroupMappings) return;
            
            const groupNames = Object.keys(window.adGroupMappings);
            if (groupNames.length === 0) {
                list.innerHTML = '<p style="color: #666; font-style: italic;">No Azure AD groups selected</p>';
            } else {
                list.innerHTML = groupNames.map(displayName => {
                    const escapedDisplayName = displayName.replace(/'/g, "\\'").replace(/"/g, "&quot;");
                    return `
                        <div style="display: inline-block; margin: 2px; padding: 6px 10px; background: #e3f2fd; 
                                    border-radius: 4px; font-size: 14px;">
                            <strong>${displayName}</strong>
                            <button onclick="removeAdGroupMapping('${escapedDisplayName}')" 
                                    style="margin-left: 8px; background: none; border: none; color: #d32f2f; 
                                           cursor: pointer; font-size: 16px;">Ã—</button>
                        </div>
                    `;
                }).join('');
            }
        };
        
        async function showRoleBuilder(clientId) {
            try {
                const accessToken = localStorage.getItem('access_token');
                
                // Fetch permission tree for the app
                const response = await fetch(`/discovery/v2/permissions/${clientId}/tree`, {
                    headers: {
                        'Authorization': `Bearer ${accessToken}`
                    }
                });
                
                if (!response.ok) {
                    showAppMessage('error', 'Failed to load permissions for role builder');
                    return;
                }
                
                const treeData = await response.json();
                const permissions = treeData.permission_tree || {};
                
                // Create modal
                const modal = document.createElement('div');
                modal.className = 'modal-overlay';
                modal.onclick = (e) => {
                    if (e.target === modal) {
                        document.body.removeChild(modal);
                    }
                };
                
                const content = document.createElement('div');
                content.className = 'modal-content';
                content.style.maxWidth = '900px';
                content.style.maxHeight = '90vh';
                content.style.overflow = 'auto';
                
                // Header
                const header = document.createElement('h2');
                header.textContent = 'Create Custom Role';
                header.style.marginBottom = '20px';
                content.appendChild(header);
                
                // Role name input
                const nameGroup = document.createElement('div');
                nameGroup.style.marginBottom = '20px';
                nameGroup.innerHTML = `
                    <label style="display: block; margin-bottom: 5px; font-weight: 500;">Role Name:</label>
                    <input type="text" id="roleName" placeholder="e.g., viewer, editor, analyst" 
                           style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                `;
                content.appendChild(nameGroup);
                
                // Description input
                const descGroup = document.createElement('div');
                descGroup.style.marginBottom = '20px';
                descGroup.innerHTML = `
                    <label style="display: block; margin-bottom: 5px; font-weight: 500;">Description:</label>
                    <textarea id="roleDescription" placeholder="Describe the purpose and scope of this role" 
                              style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; min-height: 60px;"></textarea>
                `;
                content.appendChild(descGroup);
                
                // AD Groups mapping
                const adGroupsDiv = document.createElement('div');
                adGroupsDiv.style.marginBottom = '20px';
                adGroupsDiv.innerHTML = `
                    <label style="display: block; margin-bottom: 5px; font-weight: 500;">
                        Map to Azure AD Groups:
                        <small style="color: #666; font-weight: normal;">(Users in these groups will get this role)</small>
                    </label>
                    <div id="adGroupsList" style="margin-bottom: 10px; max-height: 150px; overflow-y: auto;">
                        <!-- Selected AD groups will be shown here -->
                    </div>
                    <div style="position: relative;">
                        <input type="text" id="adGroupSearch" placeholder="Search Azure AD groups..." 
                               style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;"
                               oninput="searchAzureGroups(this.value)">
                        <div id="adGroupSearchResults" style="position: absolute; top: 100%; left: 0; right: 0; 
                             max-height: 200px; overflow-y: auto; background: white; border: 1px solid #ddd; 
                             border-top: none; border-radius: 0 0 4px 4px; display: none; z-index: 1000;">
                            <!-- Search results will appear here -->
                        </div>
                    </div>
                `;
                content.appendChild(adGroupsDiv);
                
                // Quick actions
                const quickActions = document.createElement('div');
                quickActions.style.marginBottom = '20px';
                quickActions.innerHTML = `
                    <div style="margin-bottom: 10px; font-weight: 500;">Quick Actions:</div>
                    <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                        <button onclick="selectAllPermissions()" class="btn btn-sm" style="background: #17a2b8; color: white;">Select All</button>
                        <button onclick="selectNonePermissions()" class="btn btn-sm" style="background: #6c757d; color: white;">Select None</button>
                        <button onclick="selectReadOnlyPermissions()" class="btn btn-sm" style="background: #28a745; color: white;">Read Only</button>
                        <button onclick="selectNonSensitivePermissions()" class="btn btn-sm" style="background: #ffc107; color: #333;">Non-Sensitive Only</button>
                    </div>
                `;
                content.appendChild(quickActions);
                
                // Permissions selection tree
                const permTree = document.createElement('div');
                permTree.id = 'permissionTree';
                permTree.style.marginBottom = '20px';
                permTree.style.maxHeight = '400px';
                permTree.style.overflowY = 'auto';
                permTree.style.border = '1px solid #ddd';
                permTree.style.borderRadius = '4px';
                permTree.style.padding = '10px';
                
                // The permissions object is already organized as a tree (resource -> action -> fields)
                // Render permission tree with checkboxes
                for (const [resource, actions] of Object.entries(permissions)) {
                    const resourceDiv = document.createElement('div');
                    resourceDiv.style.marginBottom = '15px';
                    
                    const resourceHeader = document.createElement('div');
                    resourceHeader.style.fontWeight = 'bold';
                    resourceHeader.style.marginBottom = '5px';
                    resourceHeader.innerHTML = `
                        <label style="cursor: pointer;">
                            <input type="checkbox" class="resource-checkbox" data-resource="${resource}" 
                                   onchange="toggleResourcePermissions('${resource}', this.checked)">
                            ${resource}
                        </label>
                    `;
                    resourceDiv.appendChild(resourceHeader);
                    
                    for (const [action, actionData] of Object.entries(actions)) {
                        const actionDiv = document.createElement('div');
                        actionDiv.style.marginLeft = '20px';
                        actionDiv.style.marginBottom = '8px';
                        
                        const actionHeader = document.createElement('div');
                        actionHeader.style.fontWeight = '500';
                        actionHeader.style.marginBottom = '3px';
                        
                        let actionLabel = action;
                        if (actionData.has_wildcard) actionLabel += ' (*)';
                        if (actionData.sensitive_count > 0) actionLabel += ` [${actionData.sensitive_count} sensitive]`;
                        
                        actionHeader.innerHTML = `
                            <label style="cursor: pointer;">
                                <input type="checkbox" class="action-checkbox" 
                                       data-resource="${resource}" data-action="${action}"
                                       onchange="toggleActionPermissions('${resource}', '${action}', this.checked)">
                                ${actionLabel}
                            </label>
                        `;
                        actionDiv.appendChild(actionHeader);
                        
                        const fieldList = document.createElement('div');
                        fieldList.style.marginLeft = '20px';
                        
                        const fields = actionData.fields || [];
                        for (const field of fields) {
                            const fieldDiv = document.createElement('div');
                            fieldDiv.style.marginBottom = '2px';
                            
                            const badges = [];
                            if (field.sensitive) badges.push('<span style="background: #f50057; color: white; padding: 1px 4px; border-radius: 3px; font-size: 10px; margin-left: 5px;">SENSITIVE</span>');
                            if (field.pii) badges.push('<span style="background: #ff9800; color: white; padding: 1px 4px; border-radius: 3px; font-size: 10px; margin-left: 5px;">PII</span>');
                            if (field.phi) badges.push('<span style="background: #9c27b0; color: white; padding: 1px 4px; border-radius: 3px; font-size: 10px; margin-left: 5px;">PHI</span>');
                            
                            fieldDiv.innerHTML = `
                                <label style="cursor: pointer; font-weight: normal;">
                                    <input type="checkbox" class="permission-checkbox" 
                                           data-permission="${field.permission_key}"
                                           data-resource="${resource}" 
                                           data-action="${action}"
                                           data-sensitive="${field.sensitive || field.pii || field.phi}"
                                           onchange="updateSelectionCounts()">
                                    <code style="background: #f5f5f5; padding: 1px 4px; border-radius: 3px; font-size: 12px;">
                                        ${field.path || field.field_path || 'undefined'}
                                    </code>${badges.join('')}
                                    ${field.description ? `<small style="color: #666; margin-left: 5px;">${field.description}</small>` : ''}
                                </label>
                            `;
                            
                            fieldList.appendChild(fieldDiv);
                        }
                        
                        actionDiv.appendChild(fieldList);
                        resourceDiv.appendChild(actionDiv);
                    }
                    
                    permTree.appendChild(resourceDiv);
                }
                
                content.appendChild(permTree);
                
                // Selection summary
                const summary = document.createElement('div');
                summary.id = 'selectionSummary';
                summary.style.marginBottom = '20px';
                summary.style.padding = '10px';
                summary.style.background = '#f8f9fa';
                summary.style.borderRadius = '4px';
                summary.innerHTML = '<span id="selectedCount">0</span> permissions selected';
                content.appendChild(summary);
                
                // Buttons
                const buttonContainer = document.createElement('div');
                buttonContainer.style.display = 'flex';
                buttonContainer.style.gap = '10px';
                buttonContainer.style.justifyContent = 'flex-end';
                
                const createBtn = document.createElement('button');
                createBtn.textContent = 'Create Role';
                createBtn.className = 'btn btn-primary';
                createBtn.style.backgroundColor = '#4CAF50';
                createBtn.onclick = async () => {
                    const roleName = document.getElementById('roleName').value.trim();
                    const roleDescription = document.getElementById('roleDescription').value.trim();
                    const selectedPerms = Array.from(document.querySelectorAll('.permission-checkbox:checked'))
                        .map(cb => cb.dataset.permission);
                    
                    if (!roleName) {
                        alert('Please enter a role name');
                        return;
                    }
                    
                    if (selectedPerms.length === 0) {
                        alert('Please select at least one permission');
                        return;
                    }
                    
                    try {
                        // Create the role first
                        const response = await fetch(`/permissions/${clientId}/roles`, {
                            method: 'POST',
                            headers: {
                                'Authorization': `Bearer ${accessToken}`,
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                role_name: roleName,
                                description: roleDescription,
                                permissions: selectedPerms
                            })
                        });
                        
                        if (response.ok) {
                            // Now map AD groups to this role if any were specified
                            const selectedGroups = Object.keys(window.adGroupMappings);
                            if (selectedGroups.length > 0) {
                                // First get existing mappings
                                const existingResponse = await fetch(`/auth/admin/apps/${clientId}/role-mappings`, {
                                    headers: {
                                        'Authorization': `Bearer ${accessToken}`
                                    }
                                });
                                
                                let existingMappings = {};
                                if (existingResponse.ok) {
                                    const data = await existingResponse.json();
                                    existingMappings = data.mappings || {};
                                }
                                
                                // Merge with new mappings (use display names as keys)
                                selectedGroups.forEach(displayName => {
                                    if (!existingMappings[displayName]) {
                                        existingMappings[displayName] = [];
                                    }
                                    if (!existingMappings[displayName].includes(roleName)) {
                                        existingMappings[displayName].push(roleName);
                                    }
                                });
                                
                                // Update mappings
                                const mappingResponse = await fetch(`/auth/admin/apps/${clientId}/role-mappings`, {
                                    method: 'POST',
                                    headers: {
                                        'Authorization': `Bearer ${accessToken}`,
                                        'Content-Type': 'application/json'
                                    },
                                    body: JSON.stringify({ mappings: existingMappings })
                                });
                                
                                if (mappingResponse.ok) {
                                    showAppMessage('success', `Role "${roleName}" created with ${selectedPerms.length} permissions and mapped to ${selectedGroups.length} Azure AD groups`);
                                } else {
                                    showAppMessage('warning', `Role "${roleName}" created but AD group mapping failed. You can map groups later.`);
                                }
                            } else {
                                showAppMessage('success', `Role "${roleName}" created with ${selectedPerms.length} permissions`);
                            }
                            document.body.removeChild(modal);
                        } else {
                            const error = await response.json();
                            showAppMessage('error', error.detail || 'Failed to create role');
                        }
                    } catch (error) {
                        showAppMessage('error', 'Error creating role: ' + error.message);
                    }
                };
                buttonContainer.appendChild(createBtn);
                
                const cancelBtn = document.createElement('button');
                cancelBtn.textContent = 'Cancel';
                cancelBtn.className = 'btn btn-secondary';
                cancelBtn.onclick = () => document.body.removeChild(modal);
                buttonContainer.appendChild(cancelBtn);
                
                content.appendChild(buttonContainer);
                
                modal.appendChild(content);
                document.body.appendChild(modal);
                
                // Initialize AD groups list
                window.adGroupMappings = {};
                updateAdGroupsList();
                
                // Define helper functions in window scope
                window.selectAllPermissions = () => {
                    document.querySelectorAll('.permission-checkbox').forEach(cb => cb.checked = true);
                    updateSelectionCounts();
                };
                
                window.selectNonePermissions = () => {
                    document.querySelectorAll('.permission-checkbox').forEach(cb => cb.checked = false);
                    updateSelectionCounts();
                };
                
                window.selectReadOnlyPermissions = () => {
                    document.querySelectorAll('.permission-checkbox').forEach(cb => {
                        cb.checked = cb.dataset.action === 'read';
                    });
                    updateSelectionCounts();
                };
                
                window.selectNonSensitivePermissions = () => {
                    document.querySelectorAll('.permission-checkbox').forEach(cb => {
                        cb.checked = cb.dataset.sensitive !== 'true';
                    });
                    updateSelectionCounts();
                };
                
                window.toggleResourcePermissions = (resource, checked) => {
                    document.querySelectorAll(`.permission-checkbox[data-resource="${resource}"]`)
                        .forEach(cb => cb.checked = checked);
                    updateSelectionCounts();
                };
                
                window.toggleActionPermissions = (resource, action, checked) => {
                    document.querySelectorAll(`.permission-checkbox[data-resource="${resource}"][data-action="${action}"]`)
                        .forEach(cb => cb.checked = checked);
                    updateSelectionCounts();
                };
                
                window.updateSelectionCounts = () => {
                    const selectedCount = document.querySelectorAll('.permission-checkbox:checked').length;
                    document.getElementById('selectedCount').textContent = selectedCount;
                    
                    // Update resource/action checkboxes based on their children
                    document.querySelectorAll('.resource-checkbox').forEach(rcb => {
                        const resource = rcb.dataset.resource;
                        const allPerms = document.querySelectorAll(`.permission-checkbox[data-resource="${resource}"]`);
                        const checkedPerms = document.querySelectorAll(`.permission-checkbox[data-resource="${resource}"]:checked`);
                        rcb.checked = allPerms.length > 0 && allPerms.length === checkedPerms.length;
                        rcb.indeterminate = checkedPerms.length > 0 && checkedPerms.length < allPerms.length;
                    });
                    
                    document.querySelectorAll('.action-checkbox').forEach(acb => {
                        const resource = acb.dataset.resource;
                        const action = acb.dataset.action;
                        const allPerms = document.querySelectorAll(`.permission-checkbox[data-resource="${resource}"][data-action="${action}"]`);
                        const checkedPerms = document.querySelectorAll(`.permission-checkbox[data-resource="${resource}"][data-action="${action}"]:checked`);
                        acb.checked = allPerms.length > 0 && allPerms.length === checkedPerms.length;
                        acb.indeterminate = checkedPerms.length > 0 && checkedPerms.length < allPerms.length;
                    });
                };
                
                
            } catch (error) {
                showAppMessage('error', 'Error loading role builder: ' + error.message);
            }
        }
        
        function showPermissionsModal(clientId, permissions) {
            // Create modal overlay
            const modal = document.createElement('div');
            modal.className = 'modal-overlay';
            modal.onclick = (e) => {
                if (e.target === modal) {
                    document.body.removeChild(modal);
                }
            };
            
            // Create modal content
            const content = document.createElement('div');
            content.className = 'modal-content';
            content.style.maxWidth = '800px';
            content.style.maxHeight = '80vh';
            content.style.overflow = 'auto';
            
            // Header
            const header = document.createElement('h2');
            header.textContent = `Discovered Permissions for ${clientId}`;
            header.style.marginBottom = '20px';
            content.appendChild(header);
            
            // Permissions tree
            const tree = document.createElement('div');
            tree.style.marginBottom = '20px';
            
            if (Object.keys(permissions).length === 0) {
                tree.innerHTML = '<p style="color: #666;">No permissions discovered yet.</p>';
            } else {
                // Build permission tree
                for (const [resource, actions] of Object.entries(permissions)) {
                    const resourceDiv = document.createElement('div');
                    resourceDiv.style.marginBottom = '15px';
                    resourceDiv.style.border = '1px solid #ddd';
                    resourceDiv.style.borderRadius = '4px';
                    resourceDiv.style.padding = '10px';
                    
                    const resourceHeader = document.createElement('h3');
                    resourceHeader.textContent = resource;
                    resourceHeader.style.margin = '0 0 10px 0';
                    resourceHeader.style.color = '#333';
                    resourceDiv.appendChild(resourceHeader);
                    
                    for (const [action, actionData] of Object.entries(actions)) {
                        const actionDiv = document.createElement('div');
                        actionDiv.style.marginLeft = '20px';
                        actionDiv.style.marginBottom = '10px';
                        
                        const actionHeader = document.createElement('h4');
                        actionHeader.textContent = action;
                        actionHeader.style.margin = '0 0 5px 0';
                        actionHeader.style.color = '#555';
                        actionHeader.style.fontWeight = 'normal';
                        
                        if (actionData.has_wildcard) {
                            actionHeader.innerHTML += ' <span style="color: #4caf50; font-size: 12px;">(has wildcard *)</span>';
                        }
                        if (actionData.sensitive_count > 0) {
                            actionHeader.innerHTML += ` <span style="color: #f50057; font-size: 12px;">(${actionData.sensitive_count} sensitive fields)</span>`;
                        }
                        
                        actionDiv.appendChild(actionHeader);
                        
                        const fieldList = document.createElement('ul');
                        fieldList.style.margin = '0';
                        fieldList.style.paddingLeft = '20px';
                        
                        const fields = actionData.fields || [];
                        for (const field of fields) {
                            const fieldItem = document.createElement('li');
                            fieldItem.style.marginBottom = '3px';
                            
                            let fieldText = field.path || field.field || field.key;
                            const badges = [];
                            
                            if (field.sensitive) badges.push('<span style="background: #f50057; color: white; padding: 2px 6px; border-radius: 3px; font-size: 11px; margin-left: 5px;">SENSITIVE</span>');
                            if (field.pii) badges.push('<span style="background: #ff9800; color: white; padding: 2px 6px; border-radius: 3px; font-size: 11px; margin-left: 5px;">PII</span>');
                            if (field.phi) badges.push('<span style="background: #9c27b0; color: white; padding: 2px 6px; border-radius: 3px; font-size: 11px; margin-left: 5px;">PHI</span>');
                            
                            fieldItem.innerHTML = `<code style="background: #f5f5f5; padding: 2px 4px; border-radius: 3px;">${fieldText}</code>${badges.join('')}`;
                            if (field.description) {
                                fieldItem.innerHTML += `<br><small style="color: #666; margin-left: 20px;">${field.description}</small>`;
                            }
                            
                            fieldList.appendChild(fieldItem);
                        }
                        
                        actionDiv.appendChild(fieldList);
                        resourceDiv.appendChild(actionDiv);
                    }
                    
                    tree.appendChild(resourceDiv);
                }
            }
            
            content.appendChild(tree);
            
            // Button container
            const buttonContainer = document.createElement('div');
            buttonContainer.style.display = 'flex';
            buttonContainer.style.gap = '10px';
            buttonContainer.style.justifyContent = 'flex-end';
            
            // Create Role button
            if (Object.keys(permissions).length > 0) {
                const createRoleBtn = document.createElement('button');
                createRoleBtn.textContent = 'Create Role';
                createRoleBtn.className = 'btn btn-primary';
                createRoleBtn.style.backgroundColor = '#4CAF50';
                createRoleBtn.onclick = () => {
                    document.body.removeChild(modal);
                    showRoleBuilder(clientId);
                };
                buttonContainer.appendChild(createRoleBtn);
            }
            
            // Close button
            const closeBtn = document.createElement('button');
            closeBtn.textContent = 'Close';
            closeBtn.className = 'btn btn-secondary';
            closeBtn.onclick = () => document.body.removeChild(modal);
            buttonContainer.appendChild(closeBtn);
            
            content.appendChild(buttonContainer);
            
            modal.appendChild(content);
            document.body.appendChild(modal);
        }
    </script>
</body>
</html>